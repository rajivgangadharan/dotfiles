$(function(){var n=null,i,c,g,I,J,h=false,l="ecscontent",C=1080,r=1920,k=chrome.runtime.id;var B="ecs-page_"+k;var t="ecs-ext";var A={connect:E,startScreenCapture:u,stopScreenCapture:z,getScreenCapture:v};var o={stream:y};var p={INIT:0,CONNECTED:1,SCREEN_REQUESTED:2,SCREEN_ACQUIRED:3,CAPTURE_ACTIVE:4};var G={CAPTURE:"capture",CAPTURE_STOPPED:"capture_stopped",CAPTURE_STARTED:"capture_started",CAPTURE_ERROR:"capture_error"};var q={CONNECTED:"connected",CAPTURE_AVAILABLE:"capture_available",SCREEN_CAPTURE:"screen_capture",CAPTURE_STOPPED:"capture_stopped",CAPTURE_ERROR:"capture_error"};function j(K){console.log("[ContentJS]"+K)}function D(){J=p.INIT;window.addEventListener("message",a)}function H(M,K){var L={name:M,data:K,src:t};if(h){window.frames.mea_iframe.contentWindow.postMessage(L,"*")}else{window.postMessage(L,"*")}}function a(K){K=K.data;if(K.src!==B){return}if(!A[K.name]){return}A[K.name](K)}function f(K){if(!o[K.name]){return}o[K.name](K)}function E(L){if(L.data.embedded){h=true}var K=L.data.maxResolution;if(K){C=K.height;r=K.width}if(J<p.CONNECTED){n=chrome.runtime.connect(k,{name:l});n.onMessage.addListener(f);J=p.CONNECTED}H(q.CONNECTED)}function u(){if(J>=p.SCREEN_REQUESTED){return}n.postMessage({name:G.CAPTURE});J=p.SCREEN_REQUESTED}function z(){if(J<=p.SCREEN_REQUESTED){return}w();n.postMessage({name:G.CAPTURE_STOPPED});J=p.CONNECTED}function v(){if(J<p.SCREEN_ACQUIRED){return}if(g.width!=c[0].videoWidth||g.height!=c[0].videoHeight){g.width=c[0].videoWidth;g.height=c[0].videoHeight}c[0].play();I.drawImage(c[0],0,0);var K=I.getImageData(0,0,g.width,g.height);J=p.CAPTURE_ACTIVE;H(q.SCREEN_CAPTURE,{image:K})}function y(K){navigator.webkitGetUserMedia({video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:K.id,maxWidth:r,maxHeight:C}}},function(L){x(L)},function(L){e(L)})}function x(K){console.dir(K);i=K;n.postMessage({name:G.CAPTURE_STARTED});K.oninactive=s;m();d(c[0],i)}function m(){c=$("<video autoplay></video>");g=$("<canvas></canvas>")[0];I=g.getContext("2d");c.one("loadeddata",F)}function F(){g.width=c[0].videoWidth;g.height=c[0].videoHeight;var K={width:g.width,height:g.height};if(J===p.SCREEN_REQUESTED){J=p.SCREEN_ACQUIRED}H(q.CAPTURE_AVAILABLE,K)}function s(){n.postMessage({name:G.CAPTURE_STOPPED});H(q.CAPTURE_STOPPED);b();J=p.CONNECTED}function w(){if(typeof i!=="undefined"){if(!("stop" in i)){i.stop=function(){this.getVideoTracks().forEach(function(K){K.stop()})}}i.stop()}b()}function b(){i=undefined;c=undefined;g=undefined;I=undefined}function e(K){n.postMessage({name:G.CAPTURE_ERROR});H(q.CAPTURE_STOPPED);J=p.CONNECTED}function d(K,L){if(typeof K.srcObject!=="undefined"){K.srcObject=L}else{if(typeof K.mozSrcObject!=="undefined"){K.mozSrcObject=L}else{if(typeof K.src!=="undefined"){K.src=URL.createObjectURL(L)}else{}}}}D()});