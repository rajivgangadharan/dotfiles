/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2020 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

*/
window.m=_.extend(window.m,{$window:$(window),appView:"",models:{},collect:{},views:{},addins:{},settingsUtils:{},bootstrappers:{},commands:{},templates:{},widgets:[],appsReady:!1,appsLoaded:!1,console:{log:function(e){m.log+=e+"\n"}},log:"",date:function(){return new Date},now:function(){return m.date().getTime()},startTime:0,elapsed:function(){return m.now()-m.startTime},isLoggedIn:function(){return localStorage.getItem("token")&&!localStorage.getItem("unregistered")},browserInfo:function(){var e,t=navigator.userAgent,i=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(i[1])?{name:"IE",version:(e=/\brv[ :]+(\d+)/g.exec(t)||[])[1]||""}:"Chrome"===i[1]&&null!==(e=t.match(/\b(OPR|Edge)\/(\d+)/))?{name:e[1].replace("OPR","Opera"),version:e[2]}:(i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/(\d+)/i))&&i.splice(1,1,e[1]),{name:i[0],version:i[1]})}(),logEnvironment:function(){var e=localStorage.getItem("api"),t=m.conditionalFeatures.featureEnabled("team"),i=m.models.teamInfo.get("team"),n=t&&i&&i.type===m.constants.organizationTypes.COMMUNITY,a=i&&i.userIsAdmin,o=m.conditionalFeatures.featureEnabled("plus"),s=m.models.backgroundManager.getActiveItem(),r=localStorage.getItem("email"),l=o&&m.models.customization.get("themeFont")||"classic",d=m.models.customization.get("themeColour")||"system",c=navigator.clipboard&&navigator.clipboard.writeText,u=("system"===d&&(d+=" ("+(m.models.themeManager.systemMediaQueryLight.matches?"Light":"Dark")+")"),{platform:{version:m.globals.version,api:"s"===e||"staging"===e?"Staging":null===e?"Live":"Local",browser:m.globals.platform+" "+m.browserInfo.version},user:{accountType:n&&a?"Community":t&&!n?"Team":o?"Plus":r?"Free":"Unregistered",email:r,id:localStorage.getItem("user_uuid"),clientId:localStorage.getItem("client_uuid")},team:{},community:{},theme:{color:m.utils.capitalizeWords(d),font:m.utils.capitalizeWords(l)},background:{title:s.get("title"),id:s.get("_id")||s.get("id"),source:s.get("source"),fallback:s.get("filename")&&s.get("filename").startsWith("backgrounds/"),custom:s.get("isCustom")}}),g=(t?(e=n?"community":"team",delete u[n?"team":"community"],u[e].name=i.teamName,u[e].id=i.teamUuid,u.user.admin=a):(delete u.team,delete u.community),"");Object.keys(u).forEach(function(i,e,t){g+=i.toUpperCase()+"\n",Object.keys(u[i]).forEach(function(e){var t=u[i][e];!t&&0!==t&&!1!==t||(g+=m.utils.camelCaseToReadable(e)+": "+t+"\n")}),e<t.length-1&&(g+="\n")}),c?navigator.clipboard.writeText(g).then(function(){g="*** Copied To Clipboard ***\n\n"+g}).catch(function(){}).finally(function(){console.log(g)}):console.log(g)}},Backbone.Events),m.firstLoadEver=!localStorage.getItem("client_uuid"),m.startTime=m.now(),Backbone.View=function(t){return t.extend({constructor:function(e){this.options=e||{},t.apply(this,arguments)}})}(Backbone.View);var key,backboneSync=Backbone.sync,originalLocalSync=(Backbone.sync=function(e,t,i){(i=i||{}).beforeSend=function(e){m.utils.setMomentumAuthHeader(e),e.overrideMimeType("application/json")},backboneSync(e,t,i)},Backbone.localSync),settingsUtils=(Backbone.localSync=function(e,t){var i=t.localStorage||t.collection.localStorage,n=localStorage.getItem(i.name);n&&(i.records=n.split(",")),originalLocalSync.apply(this,arguments)},Backbone.$=$,Backbone.ajax=$.ajax,Backbone.Model.extend=Backbone.Collection.extend=function(e,t){function i(){this.constructor=a}var n=this,a=e&&_.has(e,"constructor")?e.constructor:function(){return n.apply(this,arguments)};_.extend(a,n,t);return i.prototype=n.prototype,a.prototype=new i,e&&_.extend(a.prototype,e),Object.defineProperty(a,"__super__",{enumerable:!1,value:n.prototype}),a},localStorage.getItem("openAppleUpgradeOnLoad")&&(m.utils.openAppleUpgrade(),localStorage.removeItem("openAppleUpgradeOnLoad")),m.utils.isSafari()&&window.browser&&window.browser.runtime&&window.browser.runtime.sendNativeMessage&&browser.runtime.sendNativeMessage("com.momentumdash.momentum.safari",{eventName:"setExtensionLoadedOnce",extensionLoadedOnce:"true"}).catch(function(e){console.error("Error setting extensionLoadedOnce in shared app storage",e)}),m.templates=m.templates||{},m.templates.widgetmanager=m.templates.widgetmanager||{},m.templates.widgetmanager.metric=Handlebars.template({1:function(e,t,i,n,a){var o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<span class="metric-stat-unit">'+e.escapeExpression("function"==typeof(i=null!=(i=o(i,"metricUnit")||(null!=t?o(t,"metricUnit"):t))?i:e.hooks.helperMissing)?i.call(null!=t?t:e.nullContext||{},{name:"metricUnit",hash:{},data:a,loc:{start:{line:4,column:107},end:{line:4,column:121}}}):i)+"</span>"},compiler:[8,">= 4.3.0"],main:function(e,t,i,n,a){var o,s=null!=t?t:e.nullContext||{},r=e.hooks.helperMissing,l="function",d=e.escapeExpression,c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="view">\n\t<div class="primary">\n\t\t<div class="metric-stat">\n\t\t\t<span class="metric-stat-number">'+d(typeof(o=null!=(o=c(i,"metricValue")||(null!=t?c(t,"metricValue"):t))?o:r)==l?o.call(s,{name:"metricValue",hash:{},data:a,loc:{start:{line:4,column:36},end:{line:4,column:51}}}):o)+"</span>"+(null!=(e=c(i,"if").call(s,null!=t?c(t,"metricUnit"):t,{name:"if",hash:{},fn:e.program(1,a,0),inverse:e.noop,data:a,loc:{start:{line:4,column:58},end:{line:4,column:135}}}))?e:"")+'\n\t\t</div>\n\t\t<div class="metric-label">\n\t\t\t<span class="metric-label-name">'+d(typeof(o=null!=(o=c(i,"metricLabel")||(null!=t?c(t,"metricLabel"):t))?o:r)==l?o.call(s,{name:"metricLabel",hash:{},data:a,loc:{start:{line:7,column:35},end:{line:7,column:50}}}):o)+'</span>\n\t\t</div>\n\t</div>\n\t<span class="metric-message"></span>\n</div>\n'},useData:!0}),m.templates.widgetmanager.pane=Handlebars.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,a){var o,s=null!=t?t:e.nullContext||{},r=e.hooks.helperMissing,l="function",d=e.escapeExpression;return'<div class="app-wrapper app-placeholder nipple">\n\t<div class="app '+d(typeof(o=null!=(o=(e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]})(i,"appClass")||(null!=t?e(t,"appClass"):t))?o:r)==l?o.call(s,{name:"appClass",hash:{},data:a,loc:{start:{line:2,column:17},end:{line:2,column:29}}}):o)+'" style="height:'+d(typeof(o=null!=(o=e(i,"height")||(null!=t?e(t,"height"):t))?o:r)==l?o.call(s,{name:"height",hash:{},data:a,loc:{start:{line:2,column:45},end:{line:2,column:55}}}):o)+"; width:"+d(typeof(o=null!=(o=e(i,"width")||(null!=t?e(t,"width"):t))?o:r)==l?o.call(s,{name:"width",hash:{},data:a,loc:{start:{line:2,column:63},end:{line:2,column:72}}}):o)+'">\n\t\t<div class="app-placeholder-loading">\n\t\t\t<i class="loading-icon"></i>Loading...\n\t\t</div>\n\t</div>\n\t<div class="touch-overlay"></div>\n</div>\n<span class="app-dash toggle '+d(typeof(o=null!=(o=e(i,"label")||(null!=t?e(t,"label"):t))?o:r)==l?o.call(s,{name:"label",hash:{},data:a,loc:{start:{line:9,column:29},end:{line:9,column:38}}}):o)+'-toggle" data-test="'+d((e(i,"kebab")||t&&e(t,"kebab")||r).call(s,null!=t?e(t,"label"):t,{name:"kebab",hash:{},data:a,loc:{start:{line:9,column:58},end:{line:9,column:73}}}))+'-app-dash" data-ob="'+d((e(i,"kebab")||t&&e(t,"kebab")||r).call(s,null!=t?e(t,"label"):t,{name:"kebab",hash:{},data:a,loc:{start:{line:9,column:93},end:{line:9,column:108}}}))+'-app-dash">'+d(typeof(o=null!=(o=e(i,"label")||(null!=t?e(t,"label"):t))?o:r)==l?o.call(s,{name:"label",hash:{},data:a,loc:{start:{line:9,column:119},end:{line:9,column:128}}}):o)+"</span>\n"},useData:!0}),m.models.Manager=Backbone.Model.extend({}),m.collect.Manager=Backbone.Collection.extend({}),m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1,processing:!1,lazy:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManagerBase=Backbone.Model.extend({initialize:function(){var e=this;this.preInitialize&&this.preInitialize(),this.addinCollection=new m.collect.AddinCollection,this.loadDependencyMap(),this.listenTo(this.addinCollection,"add change",this.processPending),setTimeout(function(){e.loadFromAddinObject(!0)},50)},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var i=this,n=!1;_.each(m.addins,function(e,t){n=!0,i.addinCollection.findWhere({id:t})||i.loadEvaluatedAddin(t,e)}),n&&e&&this.processPending()},registerAddinLocalSource:function(e,t){this.addinCollection.findWhere({id:e})||this.addinCollection.add({id:e,path:t})},registerAddinFn:function(e,t){var i=this.addinCollection.findWhere({id:e});i?i.set({evaluated:!0,addInCode:t}):this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadDependencyMap:function(){if(!this.localAddins&&!this.localLoadFailed){var e=[],t={},i={},n={};this.dependencies=n;for(var a=0;a<this.configInfo.length;a++){var o=this.configInfo[a],s=o.addin.toLowerCase();s||console.log("addin not found: "+s),e.push(s),t[s]=o.id,i[o.id]=s,o.dependencies&&0<o.dependencies.length&&(n[s]=o.dependencies)}this.localAddins={addins:e,map:t,mapNameToId:i}}},ensureAddinNameLoaded:function(e,t,i,n){var a;this.localAddins?(e=e.toLowerCase(),(a=this.localAddins.mapNameToId[e])?this.ensureAddinLoaded(a,t,i,n):console.log("can't find id for addin name"+e)):console.log("localAddins info not populated in ensureAddinNameLoaded")},ensureAddinLoaded:function(e,t,i,n){var a=this,o=(e=e.toLowerCase(),this.addinCollection.get(e));if(o&&o.get("loaded"))t&&t(o);else if(!o||!o.get("loading")){var s,r,l=null;if(this.localAddins&&(s=e.toLowerCase(),r=this.localAddins.map[s])&&(l="app/"+(m.globals.isProduction?s:r)+".js"),i)try{i()}catch(e){}var d=null;if(!o&&this.dependencies[e])for(var c=this.dependencies[e],d=[],u=0;u<c.length;u++){var g=c[u];(f=this.localAddins.mapNameToId[g])&&d.push(f)}if((o=o||this.addinCollection.add({id:e,evaluated:!1,processed:!1,lazy:!1,dependencyIds:d})).get("loading"))t&&this.listenToOnce(this,"addin:loaded:"+e,function(){o.set({loading:!1,loaded:!0}),t()});else{var h=o.get("dependencyIds");if(h&&0<h.length)for(u=0;u<h.length;u++){var f=h[u],p=this.addinCollection.get(f);if(p&&!p.get("loaded")&&!p.get("loading"))return this.listenToOnce(this,"addin:loaded:"+f,function(){a.ensureAddinLoaded(e,t,i,n)}),void a.ensureAddinLoaded(f,function(){a.ensureAddinLoaded(e,t,i,n)},i,n)}o.set({loading:!0}),m.console.log(m.elapsed()+": script added "+l),t&&this.listenToOnce(this,"addin:loaded:"+e,function(){o.set({loading:!1,loaded:!0}),t()}),this.addScriptToDom(e,l)}}},addScriptToDom:function(t,e,i){var n=this.configInfo.find(function(e){return e.addin===t});n&&n.webpack?m.trigger("loadWebpackAddin",n.id,t):document.getElementById(t)||((n=document.createElement("script")).type="text/javascript",n.async=!0,n.src=e,n.id=t,i&&(n.onerror=i),document.body.appendChild(n))},getWidgets:function(){return _.filter(this.configInfo,function(e){return!!e.widget})},getCommands:function(){var i=[];return _.map(this.configInfo,function(e){if(e.commands&&0<e.commands.length)for(var t=0;t<e.commands.length;t++)i.push({id:e.commands[t],addin:e.addin})}),i},getAddinCommands:function(e){return e&&this.addinCollection.get(e).instance.commands||{}},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){var r=this;this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1,processing:!1,lazy:!1}),function(e){try{if(!e.get("processing")&&!e.get("processed")){var t=e.get("addInCode");if(t){var i={},n=e.get("dependencyIds");if(n&&0<n.length)for(var a=0;a<n.length;a++){var o=n[a],s=r.addinCollection.get(o);if(!s||!s.get("loaded"))return void r.ensureAddinLoaded(o);i[r.localAddins.map[o]]=s.instance}e.set({processing:!0}),e.instance=t(m,$,i),e.set({evaluated:!0,loading:!1,loaded:!0,processing:!0}),r.trigger("addin:loaded:"+e.id),r.trigger("addin:loaded",e.id)}}}catch(e){console.error(e)}})},evaluatePending:function(){}}),m.models.AddinManager=m.models.AddinManagerBase.extend({}),m.models.AddinManager=m.models.AddinManager.extend({configInfo:[{widget:!0,autoLoad:!0,id:"company_link",label:"Company Link",region:"top-center",requiredFeature:"company_link",addin:"dce1a4fc-4d92-41d5-8aaf-329e5f267b70"},{widget:!0,placeholderType:"metric",id:"dashlinks",class:"app-container dashlinks",region:"top-left",order:"prepend",after:".team-logo",addin:"7d9ace94-8620-4bc0-9160-fcc15d4cb578"},{widget:!0,autoLoad:!0,id:"focus_css_override",addin:"a98d637b-0035-46f3-96ac-c1bd00c950b1",requiredFeature:"noPersonalFocus"},{widget:!0,placeholderType:"none",id:"settings",dependencies:["settings_common"],addin:"1d872cf4-953a-4743-8f5e-6785bba4bd19",commands:["settings.initialize","settings.display"],elementId:"settings",class:"app-container settings",label:"Settings",appClass:"settings-app",region:"bottom-left",order:"prepend",width:500,height:400,toggleEvent:"globalEvent:key:L",closeOnEsc:"true"},{addin:"D52F5584-5033-4A16-866F-E97C7D7AC826",id:"settings_backgrounds",dependencies:["settings"],commands:["background.custom.uploadfiles","settings.panels.backgrounds"]},{addin:"1e373fa7-a454-4652-8d77-1a4fcc88c069",id:"settings_balance",dependencies:["settings"],commands:["settings.panels.balance"]},{addin:"e464eb61-05ca-4a56-9c17-6a02673aa136",id:"settings_bookmarks",dependencies:["settings"],commands:["settings.panels.bookmarks"]},{addin:"395dec66-e86b-4ece-9d10-faf466c733b5",dependencies:["settings"],id:"settings_clickup",commands:["settings.panels.clickup.config"]},{addin:"9e4cdd4d-8e0d-4b36-a159-fab66de84970",id:"settings_common"},{addin:"9b62165c-8b05-4f9b-82b3-b093f4e77dc9",dependencies:["settings"],commands:["settings.panels.general"],id:"settings_general"},{addin:"dd91d97e-fc83-4fca-b5cb-d89eb2e1dd0f",id:"settings_mantras",dependencies:["settings"],commands:["settings.panels.mantras"]},{addin:"dd106f35-669c-4079-a9e3-82ddc5244d0b",id:"settings_quotes",dependencies:["settings"],commands:["settings.panels.quotes"]},{addin:"270aaed6-337f-433f-9d02-a471b435eada",id:"settings_todo",dependencies:["settings"],commands:["settings.panels.todo"]},{addin:"c61b7775-7ab8-443a-a6b7-c8c8de6fc755",dependencies:["settings"],id:"settings_trello",commands:["settings.panels.trello.config"]},{widget:!0,placeholderType:"pane",label:"Todo",id:"todo","data-test":"todo",width:"320",region:"bottom-right",order:"append",addin:"6be10923-c6a7-4e5f-b85a-85e6159c3018",visibleSetting:"todoVisible",openState:"showTodoList",keepOpenSetting:"keepTodoState",toggleEvent:"globalEvent:key:T",appClass:"todo-app calculates-own-max-height",storedHeight:"todo-pane-height",class:"todo",commands:["settings.panels.todo"],hideEvents:["globalEvent:toggle:bottom-right"]},{widget:!0,webpack:!0,placeholderType:"none",precludingFeature:"countdown",id:"addMetric",waitFor:!0,addin:"7edcf7ba-be8a-471d-ad0b-bcc6c9351430",autoLoad:!0},{widget:!0,webpack:!0,id:"apps",requiredFeature:["app_launcher"],addin:"40203927-6651-4c0f-bc82-b25a8fe83505",browserBlacklist:"Mobile",autoLoad:!0,waitFor:!0},{widget:!0,placeholderType:"none",id:"background",addin:"b2583d87-8936-4392-8c10-56226239c391",autoLoad:!0,webpack:!0},{widget:!0,waitFor:!0,webpack:!0,placeholderType:"none",id:"background-info",addin:"cb39d5ca-eee1-4715-8fd1-62629ade4d59",autoLoad:!0},{widget:!0,webpack:!0,placeholderType:"none",id:"baseMetric",waitFor:!0,requiredFeature:"countdown",addin:"7e81b0f8-174d-47e4-891a-db28a21efae6",autoLoad:!0},{widget:!0,id:"bookmarks",label:"Bookmarks",addin:"ace9b8b8-9ae4-4c58-b484-2b177d8830e2",autoLoad:!0,webpack:!0,visibleSetting:"bookmarksVisible",browserBlacklist:["Safari","Mobile"]},{widget:!0,webpack:!0,placeholderType:"none",waitFor:!0,autoLoad:!0,id:"center-region",addin:"bdd415e2-b0b7-4cfa-a743-8ad041a99976"},{widget:!0,webpack:!0,id:"chat",requiredFeature:["plus"],addin:"dc917ca9-052c-4f29-b9f2-6ed9f4643e3z",autoLoad:!0,waitFor:!0},{widget:!0,webpack:!0,placeholderType:"none",id:"colorPicker",addin:"4fc397cd-2ac1-4748-b528-23cdf5b2ee42",autoLoad:!1},{widget:!0,webpack:!0,placeholderType:"none",id:"flashMessage",addin:"9c27b6da-6e5e-4814-a5d4-fda404ccec4f",autoLoad:!0,immediateLoad:!0},{widget:!0,webpack:!0,id:"focus-mode",addin:"748a780b-5a3e-45aa-8d42-8ce7e6e6f167",autoLoad:!0,waitFor:!0,visibleSetting:"focusModeVisible",requiredFeature:"non-legacy",browserBlacklist:["Mobile"]},{widget:!0,webpack:!0,id:"full-screen-portals",addin:"5b5bc6d5-be3c-4574-a535-c4dc05623f00",autoLoad:!0},{widget:!0,webpack:!0,id:"links",addin:"be5add07-9d85-46e4-be64-fbd686ae51e0",requiredFeature:"non-legacy",autoLoad:!0,waitFor:!0,visibleSetting:"linksVisible"},{widget:!0,webpack:!0,placeholderType:"none",id:"mockTodo",autoload:!1,addin:"21dd8e13-484f-4fa1-8224-9ebeabb1f865"},{widget:!0,webpack:!0,placeholderType:"none",id:"modal",addin:"5771dc5c-5496-4c0f-98cc-47938b40a1e0"},{widget:!0,webpack:!0,id:"notes",requiredFeature:["notes","notes-degraded"],addin:"dc917ca9-052c-4f29-b9f2-6ed9f4643e0a",visibleSetting:"notesVisible",autoLoad:!0,waitFor:!0},{widget:!0,webpack:!0,id:"plus-status-banner",addin:"c08a28ac-4979-4b38-b2e8-cf02a0c6f528",requiredFeature:["plus","custom-bg-degraded"],autoLoad:!0,waitFor:!0,browserBlacklist:["Safari"]},{widget:!0,webpack:!0,id:"pomodoro",addin:"38740ed8-2c9d-4cd9-90ea-f1115db8fa20",autoLoad:!0,waitFor:!0},{widget:!0,webpack:!0,id:"quicklinks",feature:"links",class:"links",label:"Links",appClass:"links-app calculates-own-max-height",region:"top-left",order:"prepend",width:260,openState:"LinksOpen",keepOpenSetting:"linksKeepOpen",placeholderType:"pane",precludingFeature:"non-legacy",addin:"ad54d482-248b-4abf-b5b0-a8eaf3e89132",storedHeight:"links-height",toggleEvent:"globalEvent:key:L",closeOnEsc:"true",visibleSetting:"linksVisible"},{widget:!0,webpack:!0,placeholderType:"none",id:"region-bottom-center",addin:"3b4f3654-010f-42a3-a1dd-b96efc23a83c",waitFor:!0,autoLoad:!0},{widget:!0,webpack:!0,placeholderType:"none",id:"region-center-below",addin:"e0c8a9f8-d0b1-4cb0-b754-48cb02e21cfe",waitFor:!0,autoLoad:!0},{widget:!0,webpack:!0,waitFor:!0,autoLoad:!0,id:"search",class:"app-container search",region:"top-left",addin:"162b82d0-f285-427c-8209-924f44ef4d21",visibleSetting:"searchVisible"},{widget:!0,webpack:!0,id:"soundscapes",requiredFeature:"plus",addin:"fcae7f16-a0a4-4b5e-a995-926dfff3dcf2",autoLoad:!0,waitFor:!0,browserBlacklist:["Mobile"]},{widget:!0,webpack:!0,id:"tabs",requiredFeature:["tab-stash","tab-stash-degraded"],addin:"b9735109-3d71-4681-9459-0a9ab5f7122d",autoLoad:!0,waitFor:!0,browserBlacklist:["Safari","Mobile"],visibleSetting:"tabsVisible"},{widget:!0,waitFor:!0,webpack:!0,placeholderType:"none",id:"team-logo",addin:"069a6a33-60be-431d-b95b-6e58c9055fb0",autoLoad:!0,requiredFeature:"team_logo"},{widget:!0,webpack:!0,id:"topics",requiredFeature:["topics"],addin:"d13fc525-0d8d-4516-910b-063dc88cebd3",browserBlacklist:"Mobile",autoLoad:!0,waitFor:!0},{widget:!0,webpack:!0,placeholderType:"none",order:"prepend",id:"weather",waitFor:!0,addin:"d41ec20f-7148-4ef5-89ba-9be0d8141154",autoLoad:!0}]}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0},beforeExecute:function(){}}),m.CommandManager=m.collect.Manager.extend({model:m.models.Command,initialize:function(){for(var t=this,e=(this.commandSources=new Backbone.Collection,m.commands&&_.mapObject(m.commands,function(e){t.registerCommandModel(e,!1)}),m.addinManager.getCommands()),i=0;i<e.length;i++)this.registerCommandSource(e[i]);this.listenTo(m.addinManager,"addin:loaded",function(e){e=m.addinManager.getAddinCommands(e);e&&_.mapObject(e,function(e){t.registerCommandModel(e,!1)})})},registerCommandModel:function(e,t){e=new e;e&&e.id&&(!t&&this.get(e.id)||((t=this.get(e.id))&&this.remove(t),this.add(e)),this.trigger("command:loaded:"+e.id))},registerCommandSources:function(e){e&&0<e.length&&_.each(e,this.registerCommandSource,this)},registerCommandSource:function(e){if(!e.id)throw new Error("An id property is required in cmdSrc");if(!e.addin)throw new Error("An addin property is required in cmdSrc");this.commandSources.findWhere({id:e.id})||this.commandSources.add({id:e.id,addin:e.addin})},registerCommand:function(e,t,i,n){e={defaults:{id:e},execute:t},i&&(e.canExecute=i),t=m.models.Command.extend(e);this.registerCommandModel(t,n)},getCommand:function(e){return e?this.get(e):null},ensureCommandLoaded:function(t,i,n,a){var o=this,s=this.get(t);if(s)i&&i(s);else{if(n)try{n()}catch(e){}var e,r=this.commandSources.get(t);r?(e=r.get("addin"),r.get("loading")||(r.set("loading",!0),this.listenToOnce(this,"command:loaded:"+t,function(){r.set("loading",!1),r.set("loaded",!0),i&&i()}),m.addinManager.ensureAddinLoaded(e,function(){},n,function(e){r.set("loading",!1),a&&a(e)}))):(url=m.globals.urlRootApi+"commands/"+encodeURIComponent(t),$.ajax({url:url,success:function(e){e&&(o.registerCommandSource(e),(r=o.commandSources.get(t))?r.get("loading")||(r.set("loading",!0),m.addinManager.ensureAddinLoaded(r.get("addin"),function(){r.set("loading",!1),r.set("loaded",!0),i&&i(s)},n,function(e){r.set("loading",!1),a&&a(e)})):a&&a("no command with that id is registered"))},error:function(){a&&a("no command with that id is registered")}}))}},execute:function(e){var t=this.getCommand(e);if(t)return t.execute.apply(t,[].slice.call(arguments,1))},executeAsync:function(n){var a=this,o=[].slice.call(arguments,1);return new Promise(function(t,i){a.ensureCommandLoaded(n,function(){var e=a.getCommand(n);e?t(e.execute.apply(e,o)):i()})})},getCommandAsync:function(n){var a=this;return new Promise(function(t,i){a.ensureCommandLoaded(n,function(){var e=a.getCommand(n);e?t(e):i()})})},canExecute:function(e){var t=this.getCommand(e);return!t||t.canExecute.apply(t,[].slice.call(arguments,1))},beforeExecute:function(e){var t=this.getCommand(e);if(t)return t.beforeExecute.apply(t,[].slice.call(arguments,1))},getProperties:function(e){var t=this.getCommand(e);return!t||!t.getProperties||t.getProperties.apply(t,[].slice.call(arguments,1))}}),m.models.CleanupManager=m.models.Manager.extend({initialize:function(){var e=this;this.frequencyDays=10,this.load(),this._registerMigrationCleanup(),m.now()-this.cleanupInfo.lastCleanup>this.frequencyDays*m.utils.mConst("msPerDay")&&this.listenTo(m,"appsReady",function(){setTimeout(function(){e.cleanup()},1e3)})},registerKey:function(e,t){t&&(this.cleanupInfo.cleanupOptions[e]=t),this.cleanupInfo.keys.indexOf(e)<0&&this.cleanupInfo.keys.push(e),this.save()},registerKeyPrefix:function(e,t){t&&(this.cleanupInfo.cleanupOptions[e]=t),this.cleanupInfo.keyPrefixes.indexOf(e)<0&&this.cleanupInfo.keyPrefixes.push(e),this.save()},unregisterKeyPrefix:function(e){e in this.cleanupInfo.cleanupOptions&&delete this.cleanupInfo.cleanupOptions[e];e=this.cleanupInfo.keyPrefixes.indexOf(e);0<=e&&this.cleanupInfo.keyPrefixes.splice(e,1),this.save()},cleanup:function(){for(var e,t,i=[],n=Object.keys(localStorage),a=0;a<n.length;a++)if(t=n[a],0<=this.cleanupInfo.keys.indexOf(t))i.push({key:t,options:this.cleanupInfo.cleanupOptions[t]});else for(e=0;e<this.cleanupInfo.keyPrefixes.length;e++){var o=this.cleanupInfo.keyPrefixes[e],s=this.cleanupInfo.cleanupOptions[o];if(t.startsWith(o)){if(s&&s.ignoreKeys&&0<=s.ignoreKeys.indexOf(t))break;if(s&&null!=s.pastDaysToKeep){var o=this.parseLocalDate(t.substring(o.length)),r=m.date();o<new Date(r.getFullYear(),r.getMonth(),r.getDate()-s.pastDaysToKeep)&&i.push({key:t,options:s});break}i.push({key:t,options:s});break}}i.map(function(t){t.options&&t.options.callbackWidget?m.widgetManager.getWidgetAsync(t.options.callbackWidget).then(function(e){e[t.options.callbackMethod](t.key)}):localStorage.removeItem(t.key)}),this.cleanupInfo.lastCleanup=m.now(),this.save(),!m.isLoggedIn()&&localStorage.getItem("email")&&localStorage.removeItem("email"),navigator.storage.estimate().then(function(e){var t,i=navigator.appVersion.match(/.*Chrome\/([0-9\.]+)/);i&&i.length&&(i=Number(i[1].split(".")[0]),t="brokenQuota:flashMessage:dismissed",e.usage>=Math.pow(2,64))&&i<117&&(localStorage.getItem(t)&&Number(localStorage.getItem(t))+6048e5>Date.now()||(m.$e.$emit("flashMessage",{error:!0,contact:!1,button:{text:"How-to",action:function(){window.open("https://support.google.com/chrome/answer/95414")}},message:"Please update your browser. Momentum may not work as intended with your current version of Chrome.",onDismiss:function(){localStorage.setItem(t,Date.now())}}),m.Analytics.capture("show storage estimate error flash",e)))}).catch(console.error)},save:function(){localStorage.setItem("cleanup-info",JSON.stringify(this.cleanupInfo))},load:function(){this.cleanupInfo=localStorage.getItem("cleanup-info"),this.cleanupInfo?this.cleanupInfo=JSON.parse(this.cleanupInfo):this.cleanupInfo={keyPrefixes:[],keys:[],cleanupOptions:{},lastCleanup:0}},parseLocalDate:function(e){e=e.split(/\D/);return new Date(e[0],e[1]-1,e[2])},_registerMigrationCleanup(){var t=localStorage.getObject("syncedData:migration:successful")||[];[{lsName:"pomodorosCompleted",migrationName:"pomodorosCompleted"},{lsName:"quicklinks",migrationName:"links"}].forEach(e=>{this[t.includes(e.migrationName)?"registerKeyPrefix":"unregisterKeyPrefix"](e.lsName)})}}),m.models.ThemeManager=Backbone.Model.extend({initialize:function(){},defaultFontFamily:'-apple-system, BlinkMacSystemFont, "Neue Haas Grotesk Text Pro", "Helvetica Neue", Helvetica, Arial, sans-serif',$head:$("head"),$body:$("body"),initializeThemes:function(){this.listenTo(m.models.customization,"change:themeColour",this.setThemeColor),this.listenTo(m.models.customization,"change:themeFont",this.setThemeFont),this.listenTo(m,"user:successfulLogin user:successfulLogout",this.onLoginEvent),this.listenTo(m,"background:loadSuccessful",this.setThemeColor),this.listenTo(m,"legacybackgrounds:ready",this.setThemeColor),this.loadAllThemeValues()},loadAllThemeValues:function(){this.loadThemeColor(),this.setThemeColor(),this.setThemeFont()},setColorValues:function(e,t){this.colors=t,this.setThemeColor()},saveThemeColor:function(){var e;this.colors&&m.models.customization.get("themeColourCustom")!==(e=this.toRgba(this.colors))&&m.models.customization.set("themeColourCustom",e)},loadThemeColor:function(){try{var e;m.models.customization.has("themeColourCustom")&&(e=m.models.customization.get("themeColourCustom"))&&(this.colors=new Colors({color:e}).colors)}catch(e){}},setThemeColor:function(){this.clearTheme();var e=m.models.customization.get("themeColour");switch(e){case"dark":this.setDarkTheme();break;case"light":this.setLightTheme();break;case"system":this.setSystemTheme();break;case"photo":this.setPhotoTheme();break;case"custom":this.setCustomTheme()}this.setAccentColor(e)},setDarkTheme:function(){this.$body.addClass("dark dark-full")},setLightTheme:function(){this.$body.addClass("light light-full")},setSystemTheme:function(){this.systemMediaQueryLight=window.matchMedia("(prefers-color-scheme: light)"),this.systemMediaQueryLight.addEventListener("change",this.systemMediaQueryListener.bind(this)),this.systemMediaQueryLight.matches?this.setLightTheme():this.setDarkTheme()},systemMediaQueryListener:function(e){"system"===m.models.customization.get("themeColour")&&(this.clearTheme(),e.matches?this.setLightTheme():this.setDarkTheme())},setPhotoTheme:function(){this.isPlus()&&m.models.activeBackground?this.$body.addClass("photo-match"):this.setDefaultTheme()},setCustomTheme:function(){this.isPlus()&&this.colors?this.$body.addClass("custom"):this.setDefaultTheme()},setDefaultTheme:function(){this.clearTheme(),this.setSystemTheme()},setAccentColor:function(e){var t,i,n,a=null;"custom"!==e&&m.models.activeBackground&&((t=m.models.activeBackground.getWidgetColor())?a=new Colors({color:t.hsla}).colors:"photo"===e&&this.setDefaultTheme()),(a="custom"===e&&this.colors?this.colors:a)&&((t=a.RND.hsl).a=a.alpha,i=.5<(n=a.RGBLuminance),a="custom"===e||"photo"===e?this.getHighlightColor(a,i):"",n="custom"===e||"photo"===e?"var(--color-text)":this.getSafeContrastColor(t,i,n),"custom"!==e&&"photo"!==e||(this.$body.toggleClass("light",i),this.$body.toggleClass("dark",!i)),e=":root { --color-hue: "+t.h+"; --color-sat: "+t.s+"%; --color-lit: "+t.l+"%; --color-alpha: "+t.a+"; "+(a&&"--color-accent-highlight: "+a)+";--color-accent-safe: "+n+";}",this.setThemeCss(e),this.setSafariTabTheme(t))},getHighlightColor:function(e,t){var i=e.rgb.r,t=t?0:1,n=.8*e.rgb.g+.2*t,e=.8*e.rgb.b+.2*t,i=new Colors({color:"rgb("+Math.round(255*(.8*i+.2*t))+","+Math.round(255*n)+","+Math.round(255*e)+")"}).colors.RND.hsl;return"hsl("+i.h+","+i.s+"%,"+i.l+"%)"},getSafeContrastColor:function(e,t,i){e=this.toHsla(e);return t?i<.5?e:"var(--color-light-text)":.1<i?e:"var(--color-dark-text)"},toHsla:function(e){return e.a||(e.a=1),"hsla("+e.h+" "+e.s+"% "+e.l+"% / "+e.a+")"},toRgba:function(e){return"rgba("+Math.round(255*e.rgb.r)+", "+Math.round(255*e.rgb.g)+", "+Math.round(255*e.rgb.b)+", "+e.alpha+")"},setThemeCss:function(e){this.$head.append('<style type="text/css" id="themeCss">'+e+"</style>"),m.trigger("theme:set")},setSafariTabTheme:function(e){this.$head.append('<meta id="safariTabTheme" name="theme-color" content="'+this.toHsla(e)+'">')},clearTheme:function(){this.$body.removeClass("dark dark-full light light-full custom photo-match no-hue"),this.$head.find("#themeCss").remove(),this.$head.find("#safariTabTheme").remove(),this.systemMediaQueryLight&&this.systemMediaQueryLight.removeEventListener("change",this.systemMediaQueryListener.bind(this))},isPlus:function(){return m.conditionalFeatures.featureEnabled("plus")},getAvailableFonts:function(){return[{label:"Classic",value:"default"},{label:"Modern",value:"modern"},{label:"Startup",value:"startup",breakafter:!0},{label:"Retro",value:"retro"},{label:"Warehouse",value:"warehouse"},{label:"Quirky",value:"quirky"}]},setThemeFont:function(){var t=this,i=m.models.customization.get("themeFont")||"default";if(this.isPlus()){var n=this.defaultFontFamily;if(i&&"default"!=i){var e=localStorage.getItem("font-"+i);if(e)e=JSON.parse(e),n=this.setFontFromInfo(e)||this.defaultFontFamily,this.setActiveFont(n,i);else try{$.ajax({type:"GET",url:m.globals.urlRootApi+"fonts/"+i}).done(function(e){e&&(localStorage.setItem("font-"+i,JSON.stringify(e)),n=t.setFontFromInfo(e)||t.defaultFontFamily)}).always(function(){t.setActiveFont(n,i)})}catch(e){}}else this.setActiveFont(n,i)}else this.setActiveFont(this.defaultFontFamily,i)},setFontFromInfo:function(e){var t,i,n=null;return e&&(e.builtin||(i=(t=$("head")).find("#font-"+e.font).first())&&0!=i.length||(i=null,e.fontInline?(i=$('<style type="text/css"></style>')).html(e.fontInline):e.fontUrl&&(i=$('<link rel="stylesheet" type="text/css">')).attr("href",e.fontUrl),i&&(i.attr("id","font-"+e.font),t.append(i))),n=e.exclude_default?e.fontFamily:e.fontFamily+","+this.defaultFontFamily),n},setActiveFont:function(e,t){var i=this,e="body, input, select, textarea, button { font-family: "+e+" !important; }",n=document.createElement("style"),a=$(n);a.attr("type","text/css"),document.head.appendChild(n),n.sheet.insertRule(e,0),a.attr("id","font-override"),_.each(this.getAvailableFonts(),function(e){e.value===t?i.$body.addClass("f--"+e.value):i.$body.removeClass("f--"+e.value)}),($user=$(".user")).hasClass("open")||$user.css("transform","translateY("+$("user-hidden").height()+"px)")},onLoginEvent:function(){this.listenToOnce(m,"sync:settings:complete",this.loadAllThemeValues)}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.downloading={},this.retryAfterKey="feed-retry-after",this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"skip:download",this.doDownloadAfterSkip),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange(),this.reportFeedItems()},onUserLogin:function(e){localStorage.removeItem("ts_quotes"),localStorage.removeItem("ts_backgrounds"),localStorage.removeItem("ts_mantras"),this.doDownload(),this.syncSettings(e)},reportFeedItems:function(){var i=this;this.canCallServer()&&["quote","mantra","bg"].map(function(e){var t="report-"+e,e=localStorage.getItem(t);e&&$.ajax({type:"post",contentType:"application/json",url:m.globals.urlRootApi+"feed/report",data:e}).done(function(e){i.checkForBackOff(e.retryAfter),e.success&&localStorage.removeItem(t)})})},checkForReportTasks:function(e,n){e.map(function(e){var t,i;e.reportUsage&&(t="report-"+n,(i=(i=localStorage.getItem(t))?JSON.parse(i):[]).push({id:e._id,type:n,forDate:e.forDate}),localStorage.setItem(t,JSON.stringify(i)))})},canCallServer:function(){var e=localStorage.getItem(this.retryAfterKey);if(e){if(m.date().getTime()<parseInt(e))return!1;localStorage.removeItem(e)}return!0},checkForBackOff:function(e){e&&(e=parseInt(e),localStorage.setItem(this.retryAfterKey,m.date().getTime()+1e3*e))},doDownloadAfterSkip:function(e){this.doDownload(e,!0)},doDownload:function(t,e){if(this.canCallServer()){var i,n=this;if(t)if("string"==typeof t&&(i={},t.split(/[\s,;]+/).forEach(function(e){i[e]=!0}),t=i),["quote","background","mantra"].map(function(e){n.downloading[e]&&t[e]&&delete t[e]}),0===Object.keys(t).length)return;var a=m.collect.mantras.get("pinned");this.downloading={};try{var o=this,s="";if(m.collect.backgrounds&&m.collect.backgrounds.get(m.utils.getDateString())&&(s+="b"),m.collect.quotes&&m.collect.quotes.get(m.utils.getDateString())&&(s+="q"),(m.collect.mantras&&m.collect.mantras.get(m.utils.getDateString())||a)&&(s+="m"),localStorage.client_uuid){var r=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(t){var l=[];if(t.quote&&m.models.customization.get("quoteVisible")&&(l[l.length]="quote",localStorage.removeItem(o.ddlQuoteString()),this.downloading.quote=!0),t.mantra&&m.models.customization.get("mantraVisible")&&!a&&(l[l.length]="mantra",localStorage.removeItem(o.ddlMantraString()),this.downloading.mantra=!0),t.background&&(this.downloading.background=!0,l[l.length]="background",localStorage.removeItem(o.ddlBackgroundString())),!(0<l.length))return;r+=l.join(",")}else this.downloading.background=!0,this.downloading.quote=!0,a||(this.downloading.mantra=!0),r+="all",localStorage.removeItem(o.ddlBackgroundString()),localStorage.removeItem(o.ddlQuoteString()),localStorage.removeItem(o.ddlMantraString());r=r+"&localDate="+m.utils.getDateString(),0<s.length&&(r+="&has="+s);var d,c=m.models.activeBackground.activeBackgroundUuid();c||(d=m.collect.legacyBackgrounds.getCurrentLocalBackground())&&(c=d.backgroundUuid()),c&&!e&&(r=r+"&legacyBackground="+c),$.ajax({type:"GET",contentType:"application/json",url:r}).done(function(t){["Quote","Background","Mantra"].map(function(e){t["useCurrent"+e]&&localStorage.setItem(o["ddl"+e+"String"](),m.now())}),t.quotes&&(0<t.quotes.length&&m.collect.quotes&&(m.collect.quotes.reset(t.quotes),n.checkForReportTasks(t.quotes,"quote"),m.collect.quotes.invoke("save"),localStorage.shortquote)&&localStorage.removeItem("shortquote"),t.ts_quotes&&localStorage.setItem("ts_quotes",JSON.stringify(t.ts_quotes)),localStorage.setItem(o.ddlQuoteString(),m.now())),t.mantras&&0<t.mantras.length&&m.collect.mantras&&(m.collect.mantras.reset(t.mantras),n.checkForReportTasks(t.mantras,"mantra"),m.collect.mantras.invoke("save"),localStorage.setItem(o.ddlMantraString(),Date.now()),t.ts_mantras)&&localStorage.setItem("ts_mantras",JSON.stringify(t.ts_mantras)),t.backgrounds&&(0<t.backgrounds.length&&(m.collect.backgrounds.reset(t.backgrounds),n.checkForReportTasks(t.backgrounds,"bg"),m.collect.backgrounds.invoke("save"),localStorage.background)&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds")),t.ts_backgrounds&&localStorage.setItem("ts_backgrounds",JSON.stringify(t.ts_backgrounds)),localStorage.setItem(o.ddlBackgroundString(),m.now())),n.downloading={},n.checkForBackOff(t.retryAfter),localStorage.setItem("firstSynchronized",m.now())}).fail(function(e){n.downloading={},0<e.status?(503===e.status&&n.checkForBackOff(e.getResponseHeader("retry-after")),(e=m.models.backgroundManager&&m.models.backgroundManager.latestItemDate())&&e>Date.parse(m.utils.getDateString())&&localStorage.setItem(o.ddlBackgroundString(),m.now()),(e=m.models.quoteManager&&m.models.quoteManager.latestItemDate())&&e>Date.parse(m.utils.getDateString())&&localStorage.setItem(o.ddlQuoteString(),m.now()),(e=m.models.mantraManager&&m.models.mantraManager.latestItemDate())&&e>Date.parse(m.utils.getDateString())&&localStorage.setItem(o.ddlMantraString(),Date.now())):m.trigger("sync:error")})}}catch(e){console.error(e),n.downloading={}}}},doDownloadIfNeeded:function(e){var t,i,n,a;localStorage.client_uuid&&!localStorage.getItem("registrationStatePending")&&(n=i=t=!1,e&&(e.ts_backgrounds&&(!(a=localStorage.getItem("ts_backgrounds"))||e.ts_backgrounds>JSON.parse(a))&&(t=!0),e.ts_quotes&&(!(a=localStorage.getItem("ts_quotes"))||e.ts_quotes>JSON.parse(a))&&(i=!0),e.ts_mantras)&&(!(a=localStorage.getItem("ts_mantras"))||e.ts_mantras>JSON.parse(a))&&(n=!0),t||localStorage[this.ddlBackgroundString()]||(t=!0),i||localStorage[this.ddlQuoteString()]||(i=!0),n||localStorage[this.ddlMantraString()]||(n=!0),this.downloading.quote&&(i=!1),this.downloading.background&&(t=!1),this.downloading.mantra&&(n=!1),m.models.customization.get("quoteVisible")||(i=!1),m.models.customization.get("mantraVisible")||(n=!1),e={},t&&(e.background=!0),i&&(e.quote=!0),n&&(e.mantra=!0),0<Object.keys(e).length)&&this.doDownload(e)},pingApi:function(e,t){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(){e&&e()}).fail(function(){t&&t()})},ddlBackgroundString:function(){return"ddl-bg-"+m.utils.getDateString()},ddlQuoteString:function(){return"ddl-qt-"+m.utils.getDateString()},ddlMantraString:function(){return"ddl-mantra-"+m.utils.getDateString()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");(t=m.models.customization.get("displayname")?t:m.utils.uuidv4())&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e,t){if(!(t&&t.fromStorage||this.syncSettingsInProgress||m.models.customization.fetching)&&localStorage.getItem("token")&&m.conditionalFeatures.featureEnabled("serversettings")){if(e){t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization.getPersistentSettings()),url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,i){$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({feature:e}),url:m.globals.urlRootApi+"user/featurerequest"}).done(function(){t&&t()}).fail(function(){i&&i()})},syncSettings:function(e){var t;!localStorage.getItem("client_uuid")&&!localStorage.getItem("token")||localStorage.getItem("registrationStatePending")||m.utils.shouldShowIntroduction()||m.migratingLegacyUser||(this.syncSettingsInProgress=!0,t=this,$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){t.loadSettings(e)}).fail(function(){}).always(function(){t.syncSettingsInProgress=!1,m.trigger("sync:settings:complete"),e&&e()}))},loadSettings:function(e){var i,n,t,a,o;e&&(e.user_id&&localStorage.setItem("userId",e.user_id.toLowerCase()),e.token_invalid?(e.token_invalid_reason?m.commandManager.execute("logout",e,!0):m.commandManager.execute("logout",null,!0),logout=!0):(e.createTime&&localStorage.setItem("user:createTime",e.createTime),e.greetings&&(localStorage.greetings=e.greetings),e.customization&&(t=m.models.customization.get("displayname"),m.models.customization.save(e.customization),t&&0!=t.length||setTimeout(function(){m.trigger("globalEvent:forceDisplayName")},25)),e.features&&m.conditionalFeatures.updateFeatures(e.features,!0),e.team&&m.models.teamInfo.save("team",e.team),i=localStorage.getItem("experiments:disabled"),n=localStorage.getObject("experiments:disabled:exceptions"),e.experimentEnrollments&&e.experimentEnrollments.forEach(function(t){(!i||n&&n.includes(t.experimentName))&&!m.reactive.experiments.find(function(e){return e.experimentName===t.experimentName})&&m.reactive.experiments.push(t)}),m.commandManager.execute("addins.load",e.addIns),m.commandManager.registerCommandSources(e.cmd),e.download&&m.trigger("sync:download",e.download),e.ts_notifications&&m.trigger("notifications:timestamp",e.ts_notifications),t=null,e.ts_backgrounds&&((t=t||{}).ts_backgrounds=e.ts_backgrounds),e.ts_quotes&&((t=t||{}).ts_quotes=e.ts_quotes),e.mantras&&((t=t||{}).ts_mantras=e.ts_mantras),t&&m.trigger("sync:downloadIfNeeded",t),m.trigger("sync:settings",e),t=Promise.resolve(null),e.timestamps&&(t=m.timestampService.saveServerTimestamps(e.timestamps).catch(console.error)),!m.introductionActive&&localStorage.getItem("token")&&t.then(()=>m.utils.loadOnboarding()),e.outdatedToken&&(t="settings:outdatedToken:lastAttempt",e=localStorage.getItem(t),a="settings:outdatedToken:429Until",o=localStorage.getItem(a),e>=Date.now()-2e4||o>=Date.now()-2e3||(localStorage.setItem(t,Date.now()),$.ajax({type:"get",url:m.globals.urlRootApi+"settings/token"}).done(function(e){e.token&&localStorage.setItem("token",e.token),e.token_uuid&&localStorage.setItem("token_uuid",e.token_uuid)}).fail(function(e){429===e.status&&localStorage.setItem(a,Date.now()+1e3*Number(e.response.headers["retry-after"]))})))))}}),m.collect.Feed=Backbone.Collection.extend({initialize:function(e,t){this.model=e,this.itemType=t,this.localStorage=new Backbone.LocalStorage("momentum-"+t)},getActiveItem:function(){var e;if(0<this.length)return e=m.utils.getDateString(),this.get(e)},empty:function(){return 0===this.models.length}}),m.models.FeedManager=Backbone.Model.extend({initialize:function(e,t){this.itemType=t,m.collect[t+"s"]=this.itemCollection=new m.collect.Feed(e,t)},firstFetch:function(){this.itemCollection.fetch({reset:!0})},getActiveItem:function(){var e,t=this;return this.itemCollection&&(e=this.itemCollection.getActiveItem())?(this.currentItem&&this.equals(this.currentItem,e)||(this.currentItem=e,setTimeout(function(){m.trigger(t.itemType+":active_changed",t.currentItem.get("_id"))},50)),e):null},equals:function(e,t){var i={},n={};return Object.assign(i,e.attributes),Object.assign(n,t.attributes),delete i.forDate,delete n.forDate,JSON.stringify(i)===JSON.stringify(n)},skipItem:function(e){e=!!e;var a=this,t=this.getActiveItem(),i=t.get("_id")||t.get("id"),o=m.globals.urlRootApi+this.itemType+"s/"+i+"/skip",s={is_custom:t.get("is_custom"),hard:e};return new Promise(function(i,t){try{if(!(m.isLoggedIn()&&m.conditionalFeatures.featureEnabled("plus")||e))throw"showSkipUpsell";$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(s),url:o}).done(function(e){if(e&&e.success&&m.trigger("skip:download",a.itemType),e&&e.notification){if("max_skips"===e.notification.type||0===e.notification.message.indexOf("Skip ")){var t="max"+m.utils.capitalizeFirstLetter(a.itemType)+"Skips";if(localStorage.getItem(t))return;localStorage.setItem(t,!0),e.notification.display_time||(e.notification.display_time=5e3),e.notification.viewLimit||(e.notification.viewLimit=1)}m.commandManager.execute("notification.show.enhanced",e.notification)}i(e)}).fail(function(){m.commandManager.execute("notification.show.enhanced",a.skipErrorMessage()),t()})}catch(e){var n;"showSkipUpsell"==e?"mantra"==a.itemType&&(n={cta_text:"Learn more",cta_cmd:"upsell.upgrade",title:"Skip Mantra",message:"Upgrade to skip through mantras and add your own mantras."},m.commandManager.execute("notification.show.enhanced",n)):m.commandManager.execute("notification.show.enhanced",a.skipErrorMessage()),t()}})},toggleFavorite:function(e,t){var n=this,t=t||this.getActiveItem(),a=t.get("_id")||t.get("id"),o=m.globals.urlRootApi+this.itemType+"s/"+a+"/favorite",s={is_favorite:e,is_custom:t.get("is_custom")};return new Promise(function(t,i){try{$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(s),url:o}).done(function(e){e&&e.success&&(m.trigger("sync:download",n.itemType),m.trigger(n.itemType+":favorite",{id:a,is_favorite:s.is_favorite})),t(e)}).fail(function(e){m.commandManager.execute("notification.show.enhanced",n.favouriteErrorMessage),i(e)})}catch(e){m.commandManager.execute("notification.show.enhanced",n.favouriteErrorMessage),i(e)}})},latestItemDate:function(){var t=null;return this.itemCollection.models.forEach(function(e){e=Date.parse(e.id);(!t||t<e)&&(t=e)}),t},skipErrorMessage:function(){return{message:"Oops! We weren't able to get a new "+this.itemType+". Please check your connection and try again.",viewLimit:1}},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},registerErrorMessage:{message:"Please log in or register to enable skipping.",display_time:2500}}),m.models.ConditionalFeatures=Backbone.Model.extend({defaults:{featureList:[]},initialize:function(e){this.customization=e.customization||m.models.customization;try{localStorage.f3t6b23d&&(this.setFeatures(JSON.parse(atob(localStorage.f3t6b23d))),this.checkUnregisteredFlag())}catch(e){console.error(e),this.setFeatures([])}},featureEnabled:function(e){var t;return"offlineDataOnly"===e&&!m.isLoggedIn()||(t=!0,"!"===e[0]&&(e=e.substr(1),t=!1),t===_.contains(this.get("featureList"),e))},setFeatures:function(e){m.utils.userIsLegacyUnregistered()||e.push("non-legacy"),this.set("featureList",e)},updateFeatures:function(e){localStorage.f3t6b23d=e,this.setFeatures(JSON.parse(atob(e))),this.checkUnregisteredFlag(),window.Cypress&&$("body").attr("data-test-ready-for-tests",""),m.trigger("feature:changed")},checkUnregisteredFlag:function(){var e=this.get("featureList");e.length&&!_.contains(e,"nosync")&&localStorage.removeItem("unregistered")},clearFeatures:function(){this.set({featureList:[]}),localStorage.removeItem("f3t6b23d")},checkFeatureAndMigrateData:function(e,t,i,n,a,o){var s=null,r=this;if(this.featureEnabled(e)){for(var l=!1,d=0;d<localStorage.length;d++)if(0===(keyName=localStorage.key(d)).indexOf(i+"-")){l=!0;break}if(l)try{for(var c,u,g=m.date(),h=g.getFullYear().toString()+"-"+m.utils.twoDigit(g.getMonth()+1)+"-"+m.utils.twoDigit(g.getDate())+"-"+m.utils.twoDigit(g.getHours())+":"+m.utils.twoDigit(g.getMinutes())+":"+m.utils.twoDigit(g.getSeconds()),f="migrated-"+i+"-"+h,p=[],b=[],d=0;d<localStorage.length;d++)0===(keyName=localStorage.key(d)).indexOf(i+"-")&&(b.push(keyName),c=localStorage.getItem(keyName))&&((u=JSON.parse(c)).id||(u.id=u.csid),p.push(u));var v={items:p},y=JSON.stringify(v);$.ajax({type:"POST",contentType:"application/json",data:y,url:m.globals.urlRootApi+"migrate/"+i}).done(function(){for(var e in localStorage.setItem(f,y),b)localStorage.removeItem(b[e]);localStorage.removeItem(i),m.trigger("sync:customization"),t&&!r.customization.getComputedSetting(t)||n()}).fail(function(){t&&!r.customization.getComputedSetting(t)||a()})}catch(e){console.error(e)}else s=n}else s=a;s&&(!t||this.customization.getComputedSetting(t)?s():o?o(s):this.setPreferenceChangeListener(t,s))},setPreferenceChangeListener:function(e,t){var i=this;m.listenToOnce(this.customization,"change:"+e,function(){i.customization.getComputedSetting(e)?t():i.setPreferenceChangeListener(e,t)})},checkPreferenceForRender:function(e,t,i){t&&(!e||this.customization.getComputedSetting(e)?t():i&&i(t))}}),m.models.Widget=Backbone.Model.extend({shouldShowPane:function(){var e=!0;if(this.has("keepOpenSetting")&&(e=m.models.customization.get(this.get("keepOpenSetting"))&&!m.utils.isTouchDevice()),this.has("openState")){var t=localStorage[this.get("openState")];if(t)return JSON.parse(t)&&e}return!1}}),m.collect.Widgets=Backbone.Collection.extend({model:m.models.Widget}),m.views.BasePlaceholder=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=this.model.get("region"),t=(this.model.get("order")||"append")+"To";return this.$el[t]("."+e).mFadeIn().html(this.template(model.toJSON())),this},attributes:function(){return{id:this.model.get("elementId")||this.model.get("id"),class:this.model.get("class")}},detach:function(){this.unbind(),this.stopListening(),this.undelegateEvents()}}),m.views.PanePlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.pane,open:!1,events:{"click .toggle":"toggleShow","click .touch-overlay":"hidePane"},initialize:function(){var t=this,e=(this.open=!1,this.region=this.model.get("region"),this.openStateKey=this.model.get("openState"),this.render(),this.model.get("toggleEvent")&&this.listenTo(m,this.model.get("toggleEvent"),this.toggleShow),this.model.get("hideEvents")&&_.each(this.model.get("hideEvents"),function(e){t.listenTo(m,e,t.onHideEvent)}),this.model.get("visibleSetting"));e&&this.listenTo(m.models.customization,"change:"+e,this.visibleChanged),this.model.shouldShowPane()&&this.showPane()},attributes:function(){return{id:this.model.get("id"),class:"app-container "+this.model.get("id"),"data-test":this.model.get("data-test")}},render:function(){var e,t,i,n,a,o=this.model.get("label"),s=(this.model.get("order")||"append")+"To";return this.renderedOnce||(e=this.model.get("width")+"px",t="70px",this.model.has("height")?t=this.model.get("height")+"px":(i=this.storedPaneHeight())&&(t=i+"px"),this.$el.html(this.template({label:o,appClass:this.model.get("appClass")||"",isTodo:"todo"===this.model.get("id"),height:t,width:e})),this.$app=this.$(".app"),this.$dash=this.$(".app-dash"),this.$el.addClass(this.model.get("class")||""),0===this.region.indexOf("top")&&(this.$dash.remove(),n&&n.length?n.after(this.$el):this.$el.prepend(this.$dash)),this.$(".app-wrapper").addClass("nipple-"+this.region),i=this.model.get("after"),n=i&&$(i),a=this,setTimeout(function(){n&&n.length?n.after(a.$el):a.$el[s]("."+a.region),a.$el.mFadeIn(),a.renderedOnce=!0})),this},storedPaneHeight:function(){if(this.model.has("storedHeight")){var e=this.model.get("storedHeight"),e=localStorage[e];if(e)return JSON.parse(e)}return null},toggleShow:function(e){if(this.realView&&this.realView.toggleHandler)return this.open=this.realView.toggleHandler(e),!0;e&&e.stopPropagation&&e.stopPropagation(),e&&e.preventDefault&&e.preventDefault(),this.open?this.hidePane():(m.Analytics.capture("app show",{feature:this.model.get("feature")||this.model.get("id"),method:e instanceof MouseEvent?"click":"hotkey",is_paid_event:!!this.model.get("isPlus")}),this.showPane())},showPane:function(){if(!this.open){if(this.open=!0,localStorage.setItem(this.openStateKey,this.open),this.$el.addClass("show").width(),this.$el.addClass("show-fade-in"),this.realView)this.realView.onShowPane&&this.realView.onShowPane();else{if(this.loading)return;if(!this.model.has("addin"))return;this.loading=!0,m.addinManager.ensureAddinLoaded(this.model.get("addin"))}m.trigger("globalEvent:toggle:"+this.region,this),m.trigger("globalEvent:toggle",this),this.triggerLoaded()}},hidePane:function(){var e=this;this.open&&(this.open=!1,localStorage.setItem(this.openStateKey,this.open),this.$el.removeClass("show-fade-in"),setTimeout(function(){e.$el.hasClass("show-fade-in")||e.$el.removeClass("show")},300),this.realView)&&this.realView.onHidePane&&this.realView.onHidePane()},triggerLoaded:function(){this.loadTriggered||(m.widgetManager.appReady(this.model.get("id")),this.loadTriggered=!0)},addRealView:function(e){this.realView=e,this.open&&this.realView.onShowPane&&this.realView.onShowPane()},onHideEvent:function(e){e!=this&&this.hidePane()},visibleChanged:function(){var e=this.model.get("visibleSetting"),e=m.models.customization.getComputedSetting(e),t=this;e?this.renderedOnce?(this.$el.addClass("app-container"),setTimeout(function(){t.$el.mFadeIn()},1)):this.render():(this.realView&&this.realView.tearDown&&this.realView.tearDown(),setTimeout(function(){t.$el.mFadeOut(null,null,function(){t.$el.removeClass("app-container")})},1))}}),m.views.MetricPlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.metric,initialize:function(){var e=this;this.render(),setTimeout(function(){m.addinManager.ensureAddinLoaded(e.model.get("addin"))},25),this.model.get("toggleEvent")&&this.listenTo(m,this.model.get("toggleEvent"),this.toggleShow)},render:function(){var e,t,i,n;return this.renderedOnce||(this.renderedOnce=!0,e={},(t=this.model.get("cachedKey"))&&(e=JSON.parse(localStorage.getItem(t))),t=(t=this.model.get("after"))&&$(t),i=this.model.get("region"),n=(this.model.get("order")||"append")+"To",t&&t.length?t.after(this.$el):i&&this.$el[n]("."+i),this.$el.html(this.template(e)),m.appsLoaded&&this.$el.mFadeIn()),this},toggleShow:function(e){if(this.realView&&this.realView.toggleHandler)return this.open=this.realView.toggleHandler(e),!0},addRealView:function(e){this.realView=e}}),m.models.WidgetManager=m.models.Manager.extend({skippedWidgets:[],topCenterHasContent:!1,initialize:function(){this.regions={},this.regions.logo={widgets:[],overlappingRegion:"teamlinks"},this.regions["top-left"]={widgets:[{el:"links-app",view:"teamlinks"}],overlappingRegion:"bottom-left"},this.regions["top-right"]={widgets:[{el:"base-metric",view:"metric"},{el:"weather-app",view:"weather"}],overlappingRegion:"bottom-right"},this.regions["bottom-right"]={widgets:[{el:"todo-app",view:"todoPane"},{el:"notes-app",view:"notes"}],overlappingRegion:"top-right"},this.regions.bottom={widgets:[{el:"quote",view:"quote"}],overlappingRegion:"top-right"},this.regions["bottom-left"]={widgets:[{el:"settings",view:"settings"}],overlappingRegion:"top-left"},this.waitingFor=["background"],m.console.log(m.elapsed()+": initialized widgetManager")},setupWhenReady:function(){var e=this;m.models.customization.initialized?e.setup():this.listenToOnce(m.models.customization,"initialized",function(){e.setup()})},setup:function(){this.widgets&&this.widgets.each(function(e){e.placeholder&&e.placeholder.remove()}),this.widgets=m.collect.widgets=new m.collect.Widgets,this.listenTo(this.widgets,"add",this.onAdd),this.listenTo(m,"readyForWidgets",this.onSuccessfulLogin),this.listenTo(m,"feature:changed",this.onSuccessfulLogin),this.populateWidgets()},checkWidgetTimeout:function(){var e,t;m.reactive.appsReady||(e=m.elapsed(),t=this,e<1500?setTimeout(function(){t.checkWidgetTimeout()},1500-e):(this.firstShow(!0),console.warn("Widget Timeout Exceeded: Ensure all waited on apps are calling widgetManager.appReady(). Waiting for: ",this.waitingFor),m.$e.$emit("widgets:timeoutExceeded")))},populateWidgets:function(){m.console.log(m.elapsed()+": populating widgets");var t=this;_.forEach(m.addinManager.getWidgets(),function(e){t.widgets.add(e)})},onAdd:function(e){this.addWidget(e)},onSuccessfulLogin:function(){var t=this,e=this.skippedWidgets;this.destroyWidgetsWithPrecludingFeatures(),this.skippedWidgets=[],_.each(e,function(e){t.addWidget(e)})},destroyWidgetsWithPrecludingFeatures:function(){var t=this;this.widgets.forEach(function(e){e.has("precludingFeature")&&!t.skippedWidgets.includes(e)&&t.someFeaturesEnabled(e.get("precludingFeature"))&&m.trigger("destroyWidget:"+e.get("id"))})},someFeaturesEnabled:function(e){var t=!1;Array.isArray(e)||(e=[e]);for(var i=0;i<e.length;i++)if(m.conditionalFeatures.featureEnabled(e[i])){t=!0;break}return t},addWidget:function(t,e){var i=this,n=(e=e||!1,t.get("browserBlacklist"));if(!n||!(n.includes(m.globals.platform)||n.includes("Mobile")&&m.utils.isTouchDevice()))if(m.readyForWidgets||t.get("immediateLoad")){n=!0;if(n=(n=t.has("requiredFeature")?this.someFeaturesEnabled(t.get("requiredFeature")):n)&&t.has("precludingFeature")?!this.someFeaturesEnabled(t.get("precludingFeature")):n){n=m.models.teamInfo.get("team");if(!t.has("emptyFlag")||!n||n.userIsAdmin||!n[t.get("emptyFlag")]){if(!e&&t.has("visibleSetting")){var a=t.get("visibleSetting");function o(){var e=!!m.models.customization.getComputedSetting(a);i.addWidget(t,e),m.models.customization.off("change:"+a),m.models.customization.off("visibilityOverride:"+a)}if(!m.models.customization.getComputedSetting(a))return m.models.customization.once("change:"+a,o),void m.models.customization.once("visibilityOverride:"+a,o)}"metric"===t.get("placeholderType")?(t.placeholder=new m.views.MetricPlaceholder({model:t}),this.waitFor(t)):"pane"===t.get("placeholderType")?(t.shouldShowPane()&&this.waitFor(t),t.placeholder=new m.views.PanePlaceholder({model:t})):(t.get("autoLoad")||t.shouldShowPane())&&(t.get("waitFor")&&this.waitFor(t),m.addinManager.ensureAddinLoaded(t.get("addin"))),t.placeholder&&m.once("destroyWidget:"+t.get("id"),function(){t.placeholder&&(t.placeholder.undelegateEvents(),t.placeholder.remove(),Backbone.View.prototype.remove.call(t.placeholder))}),this.topCenterHasContent||"top-center"===(m.models.customization.get("appRegionOverrides")[t.get("id")]||t.get("region"))&&(this.topCenterHasContent=!0,$(".top-row").addClass("has-center"))}}else this.skippedWidgets.push(t)}else this.skippedWidgets.push(t)},waitFor:function(e){this.waitingFor.push(e.id)},loadWidget:function(e){var n=this.widgets.find({id:e});return n?new Promise(function(t,i){m.addinManager.ensureAddinLoaded(n.get("addin"),function(e){t(e)},null,function(e){i(e)})}):Promise.resolve()},getWidget:function(e){return this.widgets.find({id:e}).realview},getWidgetAsync:function(i){var n=this;return new Promise(function(e){var t=n.widgets.find({id:i});t.realview?e(t.realview):n.loadWidget(i).then(function(){e(t.realview)})})},registerWidget:function(e,t){this.widgets.add({id:e},{silent:!0}),this.widgets.find({id:e}).realview=t},handover:function(e,t,i){i=i||{};var n=this.widgets.find({id:e});if(n){var a,e=n.placeholder,o=(e&&("pane"===(a=n.get("placeholderType"))?i.el=e.$app:"metric"!==a&&"dashIcon"!==a||(i.el=e.el)),this);if(t)return a=new t(i),n.realview=a,n.shouldRender&&a.render(),o.updatePlaceHolder(n.placeholder,a,i.el),a;i.bootstrap&&(n.bootstrap=i.bootstrap,n.bootstrap)&&m.readyForWidgets&&n.bootstrap(i.el,function(e){n.realview=e,n.shouldRender&&e.render(),o.updatePlaceHolder(n.placeholder,e,i.el)})}},updatePlaceHolder:function(e,t,i){$(i&&i[0]).closest(".app-placeholder").removeClass("app-placeholder"),e&&e.addRealView(t)},refocusOverlap:function(e){$("."+this.regions[e].overlappingRegion).removeClass("unfocus")},unfocusOverlap:function(o,s){var r=this;setTimeout(function(){var n,e,t,i=r.regions[o].overlappingRegion,a=r.regions[i],i=$("."+i);(!s||(n=[],a.widgets.forEach(function(e){var t=0,i=m.views[e.view];t=(i=!i&&window.addin?addin.views[e.view]:i)&&i.getCurrentHeight?i.getCurrentHeight():0<(i=$("."+e.el)).length&&i.is(":visible")?i.height():0,n.push(t)}),a=$("."+o).height()+i.height()+Math.max.apply(null,n),t=0,(e=$(".bookmarks-wrapper")).css("transform")&&(t=parseInt(e.css("height"))-parseInt(e.css("transform").split(",")[5])),$("body").height()-(a+t+4)<s))&&i.addClass("unfocus")},1)},hideApps:function(e){var t=(e=e||{}).exemptionSelectors,i=e.immediate,n=$(".app-container"),a=$(".apps");this.timeout&&clearTimeout(this.timeout),n.each(function(){$(this).css({opacity:""})}),e.layer&&e.layer!==m.hideAppExemptionLayerStack.getLayer().key&&(this.removeAppExemption(".apps .show-anyway","_"),m.hideAppExemptionLayerStack.addLayer(e.layer),this._applyExemptionsForTopLayer()),t&&this.addAppExemption(t,e.layer),i&&a.addClass("u--no-transition"),a.addClass("hide-apps"),i&&setTimeout(function(){a.removeClass("u--no-transition")},10)},addAppExemption:function(e,t){this._toggleAppException(e,!0,t)},addVueAppExemption:function(e,t){e.forEach(function(e){m.showAnyway.show(e),m.hideAppExemptionLayerStack.addAppExemptionToLayer(e,t,!0)})},removeAppExemption:function(e,t){this._toggleAppException(e,!1,t)},removeVueAppExemption:function(e,t){e.forEach(function(e){m.showAnyway.hide(e),m.hideAppExemptionLayerStack.removeAppExemptionFromLayer(e,t,!0)})},_toggleAppException:function(e,a,o){$(e).each(function(){var e,t,i,n=$(this);o&&!a&&!m.hideAppExemptionLayerStack.getLayer(o)&&"_"!==o||(t=!0,(e=n.data("show-anyway"))&&m.showAnyway[a?"show":"hide"](e),e||(n[a?"addClass":"removeClass"]("show-anyway"),(i=n.attr("data-show-anyway-backbone"))?e=i:(e=m.utils.uuidv4(),n.attr("data-show-anyway-backbone",e)),t=!1),a?m.hideAppExemptionLayerStack.addAppExemptionToLayer(e,o,t):m.hideAppExemptionLayerStack.removeAppExemptionFromLayer(e,o,t))})},_applyExemptionsForTopLayer:function(){var e=m.hideAppExemptionLayerStack.getLayer();e.vueExemptions.size&&this.addVueAppExemption(Array.from(e.vueExemptions)),e.backboneExemptions.size&&this.addAppExemption(Array.from(e.backboneExemptions).map(function(e){return'[data-show-anyway-backbone="'+e+'"]'}).join(", "))},showApps:function(e){var t,i=(e=e||{}).hideFirst;(i||this.backgroundIsReady)&&(this.timeout&&clearTimeout(this.timeout),t=$(".apps"),i&&(t.addClass("u--no-transition"),t.removeClass("show-apps"),setTimeout(function(){t.removeClass("u--no-transition"),t.removeClass("hide-apps")},10)),t.removeClass("hide-apps"),this.removeAppExemption(".apps .show-anyway",e.layer),e.layer)&&m.hideAppExemptionLayerStack.removeLayer(e.layer)&&m.hideAppExemptionLayerStack.getLayer().key&&(this.hideApps(),this._applyExemptionsForTopLayer(e.layer))},appReady:function(e,t){m.console.log(m.elapsed()+": "+e+" is ready"),this[e+"IsReady"]=!0;e=this.waitingFor.indexOf(e);0<=e&&(this.waitingFor.splice(e,1),t||this.firstShow())},showDashboard:function(){document.getElementById("main-view").style.visibility="visible"},firstShow:function(e){var t=this;m.reactive.appsReady||0!==this.waitingFor.length&&m.readyForWidgets&&!e||(this.showDashboard(),$("body").removeClass("blur show-otl"),setTimeout(function(){m.reactive.appsReady||(t.setBottomSideWidth(),m.introductionActive||""!==m.hideAppExemptionLayerStack.getLayer().key||t.showApps(),m.reactive.appsReady=!0,m.appsReadyAt=m.now(),m.trigger("appsReady"))},1),setTimeout(function(){m.appsLoaded=!0,t.loadImages(),setTimeout(function(){m.models.activeBackground.preCacheFutureBackgroundImages(),window.chrome&&chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener(function(e){"hot-reload"===e.type&&window.location.reload()})},50)},500))},loadImages:function(){for(var e=document.getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("data-src")&&e[t].setAttribute("src",e[t].getAttribute("data-src"))},setBottomSideWidth:function(){document.documentElement.style.setProperty("--bottom-side-width","auto");var e=$(".bottom-left").width();document.documentElement.style.setProperty("--bottom-side-width",Math.round(e)+"px")}}),m.models.Image=Backbone.Model.extend({loading:!1,success:!1,failed:!1,timeoutId:null,initialize:function(){},load:function(e,n){if(!this.loading){var a=this,o=this.get("url"),s=this.get("uuid");if(null===o)o="backgrounds/"+s+".jpg";else if(!o)return void i("imageUrl is missing");var t,r=this.get("variant");this.success?m.trigger("image:loaded",s,o,r,n):(this.loading=!0,(t=new Image).onload=function(){a.success=!0,a.cleanup();var e=!1,t=a.get("height"),i=a.get("width");t&&i?this.height==t&&this.width==i||(e=!0):a.get("skip_check")||(this.height<750||this.width<1e3)&&(e=!0);e?(a.failed=!0,localStorage.setItem("failed:"+o,"true"),r&&0,m.trigger("image:error",s)):(a.loading=!1,m.trigger("image:loaded",s,o,r,n))},t.onerror=i,e&&(this.timeoutId=setTimeout(function(){a.success||m.trigger("image:timeout")},e)),m.utils.isChromium()?o&&o.lastIndexOf("momo_cache_bg_uuid")<0&&(o=o+"?momo_cache_bg_uuid="+s):o&&0<o.lastIndexOf("momo_cache_bg_uuid")&&((e=o.split("?")).pop(),o=e.join("?")),t.setAttribute("src",o))}function i(e){a.failed=!0,a.loading=!1,a.cleanup();e&&JSON.stringify(e),m.trigger("image:error",s)}},cleanup:function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}}),m.models.ImageManager=Backbone.Model.extend({images:{},initialize:function(){},loadImage:function(e,t,i){try{var n,a=e.uuid;return this.images.hasOwnProperty(a)?n=this.images[a]:(n=new m.models.Image(e),this.images[a]=n),n.load(t,i),!0}catch(e){console.error(e)}return!1},preCacheFutureBackgroundImages:function(e){var t,i=this;e&&0<e.length&&(t=e.findWhere({cached:!1}))&&(this.listenToOnce(m,"image:loaded",function(){i.preCacheFutureBackgroundImages(e)}),i.preCacheBackgroundImage(t))},preCacheBackgroundImage:function(e){var t,i;e&&((i={uuid:e.backgroundUuid(),url:t=e.get("filename")}).height=e.get("height"),i.width=e.get("width"),i.skip_check=!!e.get("skip_check"),i.variant=e.get("variant"),t)&&this.loadImage(i,null,!0)}}),m.models.BackgroundBase=Backbone.Model.extend({defaults:{cached:!1},backgroundUuid:function(){var e=this.get("_id");return e||(0!==(e=this.get("filename")).indexOf("http")&&2==(e=e.split("/")).length&&2==(e=e[1].split(".")).length?e[0]:null)}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(m,"waitForPhotoActivation",this.waitForPhotoActivation,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){0<e.backgrounds.length&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var e=this.fallbackKey(),t=localStorage.getItem(e),i=null;this.legacyBackgrounds.initialized?t?((i=this.legacyBackgrounds.getBackground(t))||(i=this.legacyBackgrounds.getCurrentLocalBackground())&&localStorage.setItem(e,i.backgroundUuid()),i&&(this.usingFallback=!0,this.setActiveBackground(i,!0))):i||(i=this.legacyBackgrounds.getCurrentLocalBackground())&&(localStorage.setItem(e,i.backgroundUuid()),this.usingFallback=!0,this.setActiveBackground(i,!0)):this.legacyBackgrounds.waitingForFallback=!0},waitForPhotoActivation:function(e){this.isWaitingForPhotoActivation=e},collectionReady:function(){this.checkActiveBackground(),this.isWaitingForPhotoActivation=!1},fallbackKey:function(){return"fallback-"+m.utils.getDateString()},legacyCollectionReady:function(){0<this.backgrounds.length&&this.backgrounds.get(m.utils.getDateString())||this.checkActiveBackground(),m.trigger("legacybackgrounds:ready")},getWidgetColor:function(){var e,t,i;return this.backgroundItem?(e=this.backgroundItem.get("widgetColor"),!this.isCustom()&&!e&&this.backgroundItem.get("isBuiltIn")&&0<this.legacyBackgrounds.length?this.legacyBackgrounds.getBackground(this.activeBackgroundUuid()).get("widgetColor"):(t=this.backgroundItem.get("filename"),void 0===e&&t&&(i=this,m.colorService.getAccentColor(t).then(function(e){i.backgroundItem.save({widgetColor:e}),m.models.themeManager.setAccentColor(m.models.customization.get("themeColour"))})),e)):null},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e;this.backgrounds&&0<this.backgrounds.length&&(e=this.backgrounds.getActiveItem())?this.setActiveBackground(e):this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem)},setActiveBackground:function(e,t){this.legacyBackgrounds.waitingForFallback=!1,!e||e.has("_id")&&this.lastBgId==e.get("_id")||(this.lastBgId=e.get("_id"),this.backgroundItem&&this.backgroundItem.cid==e.cid)||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activeChanged",e,!!t))},generateUUID:function(){var i=m.date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==e?t:3&t|8).toString(16)})},preCacheFutureBackgroundImages:function(){m.models.imageManager.preCacheFutureBackgroundImages(this.backgrounds)},isCustom:function(){if(this.backgroundItem)return this.backgroundItem.get("isCustom")}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t,i=e.id;i||2==(t=e.filename.split("/")).length&&2==(t=t[1].split(".")).length&&(i=t[0]),this.set({id:i,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl,widgetColor:e.widgetColor})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(t){return filtered=this.filter(function(e){return e.get("fallbackDate")<t}),new m.collect.Fallbacks(filtered)}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){this.initialized=!1,this.listenTo(this,"reset",function(){this.initialized=!0,this.waitingForFallback&&m.models.activeBackground.trigger("background:fallback")}),localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getBackground:function(e){return this.get(e)},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),t=localStorage.getItem(t);if(!(e=t?this.get(t):e)){if(!this.parseRecentFallbacks())return null;var t=Math.floor(.75*this.models.length),i=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),i=_.first(i,t),i=_.map(i,function(e){return e.get("backgroundGuid")}),n=this.pluck("id"),a=(m.collect.backgrounds&&(a=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))}),t=Math.floor(.25*this.models.length),a=_.first(a,t),t=_.map(a,function(e){return e.get("_id")}),i=_.union(i,t)),_.difference(n,i));e=0<a.length?(t=_.sample(a),this.get(t)):this.sample()}return e},parseRecentFallbacks:function(){var i;return this.fallbacks||(this.fallbacks=new m.collect.Fallbacks,i=this,Object.keys(localStorage).forEach(function(e,t){0===e.indexOf("fallback-")&&(e=e.slice(9),e=Date.parse(e),e=new Backbone.Model({fallbackDate:e,backgroundGuid:t}),i.fallbacks.add(e))})),!0}}),m.models.BackgroundManager=m.models.FeedManager.extend({initialize:function(){m.models.FeedManager.prototype.initialize.call(this,m.models.Background,"background"),m.models.imageManager=new m.models.ImageManager,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds}),this.listenTo(m,"image:loaded",this.markBackgroundAsCached),m.widgetManager.loadWidget("background")},firstFetch:function(){var e=m.collect.backgrounds,t=m.collect.legacyBackgrounds;m.firstLoadEver&&(e=m.collect.legacyBackgrounds,t=m.collect.backgrounds,m.firstLoadEver=!1),e.fetch({reset:!0}),setTimeout(function(){t.fetch({reset:!0})},500)},getActiveItem:function(){return m.models.activeBackground.backgroundItem},markBackgroundAsCached:function(e,t,i){e={_id:e},i&&(e.variant=i),i=m.collect.backgrounds.where(e);i&&i.forEach(function(e){e&&e.get("testOnly")?e.destroy():e.save("cached",!0)})}}),m.collect.SyncedCollection=Backbone.Collection.extend({loadedOnce:!1,initialize:function(e,t){this.model=t.model,this.version=2,this.rate=0,this.rateLimit=5,this.sameTimeThreshold=100,this.backOffTime=1e4,this.lastCall=0,this.name=t.name,localStorage.getItem("syncedCollectionVersion-"+this.name)||(this.migrate(),localStorage.setItem("syncedCollectionVersion-"+this.name,this.version)),this.offlineOnly=t.offlineOnly,this.readOnly=t.readOnly,t.onlineOnly?(this.onlineOnly=!0,this.idAttribute=this.serverIdAttribute="id"):(this.idAttribute=t.idAttribute||"csid",this.serverIdAttribute=t.serverIdAttribute||"id",this.localStorage=new Backbone.LocalStorage(t.name)),this.apiUrl=t.apiUrl||m.globals.urlRootApi+t.name,this.listenTo(this,"add",this.onAdd),this.listenTo(this,"change",this.onChange),this.listenTo(this,"reset",this.onReset),this.includeArchived=!1,this.transientProps=t.transientProps||[],this.transientProps.push("syncing"),this.localProps=t.localProps||[],this.localProps.push("serverSetId",this.serverIdAttribute),this.sorted=t.sorted,this.parent=t.parent},everLoaded:function(){return this.offlineOnly||this.onlineOnly||!!localStorage.getItem(this.name+"-loaded-once")},setLoadedOnce:function(){this.parent&&this.parent.set({loadedOnce:!0},{silent:!0,ignoreRender:!0,ignoreSave:!0});var e=!this.loadedOnce;return e&&this.trigger("loaded-from-server"),localStorage.setItem(this.name+"-loaded-once","true"),this.loadedOnce=!0,this.loading=!1,e},fetch:function(e){var t=this;(e=e||{}).skipLocalFetch||Backbone.Collection.prototype.fetch.call(this,e),this.offlineOnly||e.skipServerFetch||this.isComputed?this.setLoadedOnce()&&this.trigger("refresh"):!e.skipLocalFetch&&e.reset||this.onlineOnly||this.fetchFromServer(e.skipLocalFetch?function(){t.trigger("sync",t,t.models,e),e.success&&e.success()}:null,e.skipLocalFetch?e.error:null,e)},create:function(e,t){if(this.onlineOnly)return Backbone.Collection.prototype.create.call(this,e,t);t=t||{},e[this.idAttribute]||(e[this.idAttribute]=m.utils.uuidv4()),e.serverSetId||(e.serverSetId=!1);e=this.add(e,t);return e.id=e.get(this.idAttribute),e.collection=this,e.save({},{silent:!0,ignoreSave:!0,ignoreRender:!0}),t.success&&t.success(e),e},migrate:function(){var i=this,e=localStorage.getItem(this.name);e&&0!==(e=e.split(",")).length&&e.map(function(e){var e=i.name+"-"+e,t=localStorage.getItem(e);t&&!(t=JSON.parse(t))[i.idAttribute]&&(t[i.idAttribute]=t.id,t=JSON.stringify(t),localStorage.setItem(e,t))})},activeItems:function(){return this.filter(function(e){return!e.get("deleted")})},onReset:function(e,t){var i;this.onlineOnly||(this.fetchedOnce=!0,this.offlineOnly&&this.setLoadedOnce()&&this.trigger("refresh"),(i=this).models.forEach(function(t){t.id=t.get(i.idAttribute),i.transientProps&&i.transientProps.forEach(function(e){t.attributes[e]=!1}),t.get("serverSetId")||t.set("serverSetId",!1)}),this.offlineOnly)||this.isDummy||this.syncToServer(function(){i.fetchFromServer(null,null,t)})},findHavingAttribute:function(t){return this.filter(function(e){return e.has(t)})},hasAttribute:function(t){return!!this.find(function(e){return e.has(t)})},onAdd:function(n,e,t,i){var a,o,s,r,l;(t=t||{}).ignoreSave||n.get("unsyncable")||n.get("syncing")&&n.get("syncing")>m.now()||n.get("serverSetId")||n.get("deleted")||this.isValidModel&&!this.isValidModel(n)||this.readOnly||this.offlineOnly||this.onlineOnly||this.shouldIgnoreSync&&this.shouldIgnoreSync(n)?i&&i():(a=n.toJSON(),o=n.get(this.idAttribute),this.transientProps=this.transientProps||[],this.transientProps.push("syncing"),this.transientProps.forEach(function(e){delete a[e]}),this.localProps&&this.localProps.forEach(function(e){delete a[e]}),n.set({syncing:m.now()+1e4},{silent:!0}),(s=this).syncInProgress=!0,s.idAttribute!==s.serverIdAttribute&&delete a[s.idAttribute],r={},Object.assign(r,a,t.additionalData),l=n.get("changed_props")&&n.get("changed_props").toString(),r.csid=o,$.ajax({url:n.apiUrl||this.apiUrl,contentType:"application/json",type:"POST",data:JSON.stringify(r)}).done(function(e){e&&e[s.serverIdAttribute]&&(a=n.toJSON(),n.get("changed_props")&&n.get("changed_props").toString()===l&&(a.changed_props=null),a.serverSetId=!0,a.syncing=0,delete a[s.idAttribute],a[s.serverIdAttribute]=e[s.serverIdAttribute],n=s.getModel(n,o))&&(n.save(a,{silent:!0}),n.saveHandler)&&n.saveHandler(e),t.serverSuccess&&t.serverSuccess(n)}).fail(function(e,t,i){"Bad Request"===i&&(n=s.getModel(n,o))&&(n.id=n.get(n.idAttribute),n.destroy({silent:!0}))}).always(function(){(n=s.getModel(n,o))&&n.set({syncing:0},{silent:!0}),s.syncInProgress=!1,s.missedSync&&(s.missedSync=!1,s.syncToServer()),i&&i()}))},getModel:function(e,t){var i={},n=(i[this.idAttribute]=t,this.findWhere(i));return n||((i={})[this.serverIdAttribute]=t,n=this.findWhere(i)),n=!n&&e&&e.mainContent?this.findWhere(e.mainContent()):n},onChange:function(e,t){if(!(this.readOnly||this.offlineOnly||this.onlineOnly||t&&t.skipServerSync)){var i=this;if(!(t=t||{}).ignoreSave){var n=e.changedAttributes();if(n&&!n[this.idAttribute]&&!t.createdNow){var a,o=null,s=!1;for(a in this.transientProps&&this.transientProps.forEach(function(e){delete n[e]}),this.localProps&&this.localProps.forEach(function(e){delete n[e]}),n)n.hasOwnProperty(a)&&"changed_props"!==a&&(o=o||e.get("changed_props")||[],_.contains(o,a)||(a!==i.idAttribute&&o.push(a),s=!0));var r=!1;if(!e.get(this.serverIdAttribute)&&Object.keys(n).length){if(!(e.get("syncing")&&e.get("syncing")>m.now()))return void this.onAdd(e,this,t);r=!0,i.syncScheduled=!0,setTimeout(function(){i.syncToServer(t.serverSuccess)},1e3)}s&&o&&0<o.length&&e.save({changed_props:o},{silent:!0,ignoreSave:!0,ignoreRender:!0,success:function(){t.postponeSync||r||i.syncToServer(t.serverSuccess)}})}}}},syncToServer:function(r){var l,e,t,i,d;function c(){++e===t.length+i.length&&(l.syncInProgress=!1,e=0,l.missedSync&&(l.missedSync=!1,l.syncToServer()),r?r():l.fetchFromServer(null,null,l.lastFetchOptions))}this.readOnly||this.offlineOnly||this.onlineOnly?r&&r():this.syncInProgress?this.missedSync=!0:((l=this).syncInProgress=!0,e=0,t=this.findHavingAttribute("changed_props"),(i=this.where({serverSetId:!1}))?Array.isArray(i)||(i=[i]):i=[],i.forEach(function(e){l.onAdd(e,null,null,function(){c()})}),t&&0!==t.length?(d=!1,t.forEach(function(i){var t,n,a,o,e,s;!d&&i.get(l.serverIdAttribute)&&(t=i.get("changed_props"),n=t.toString(),l.transientProps&&l.transientProps.forEach(function(e){e=t.indexOf(e);0<=e&&t.splice(e,1)}),l.localProps&&l.localProps.forEach(function(e){e=t.indexOf(e);0<=e&&t.splice(e,1)}),t&&0!==t.length?(i.syncing=!0,a={},_.each(t,function(e){"changed_props"!==e&&e!==l.idAttribute&&(a[e]=i.get(e))}),l.isWithinRateLimit()||l.syncScheduled?l.syncScheduled||(i.getSupplementaryData&&Object.assign(a,i.getSupplementaryData()),o=i.get(l.serverIdAttribute),e=(i.apiUrl||l.apiUrl)+"/"+encodeURIComponent(o),s=i.get(l.idAttribute),$.ajax({url:e,contentType:"application/json",type:"PATCH",data:JSON.stringify(a)}).done(function(e,t){(i=l.getModel(i,s))&&(e&&e.success||"success"===t)&&(i.collection&&i.get("deleted")?i.destroy({silent:!0}):i.get("changed_props")&&i.get("changed_props").toString()===n&&i.collection&&i.save({changed_props:null},{silent:!0}),"T"===o[0])&&l.fetch({reset:!0,skipLocalFetch:!0})}).always(function(){c()})):(l.syncScheduled=!0,setTimeout(function(){l.syncScheduled=!1,l.syncToServer(r)},l.backOffTime),l.syncInProgress=!1,d=!0)):(i.save({changed_props:null},{silent:!0}),c()))})):0===i.length&&(this.syncInProgress=!1,r)&&r())},isWithinRateLimit:function(){var e=m.now();if(e<this.lastCall+this.sameTimeThreshold){if(this.lastCall=e,this.rate++,this.rate>this.rateLimit)return!1}else this.rate=0;return this.lastCall=e,!0},fetchFromServer:function(e,t,o){var i,s;this.lastFetchOptions=o,this.syncScheduled||(o=o||{},i=m.now()-this.lastFetch<500,this.offlineOnly||o.skipServerFetch||i?e&&e():(this.lastFetch=m.now(),i=o.data,s=this,$.ajax({url:this.apiUrl+(this.includeArchived?"?includeArchived=true":""),contentType:"application/json",type:"GET",data:i}).done(function(e){var n=!1;if(e)if("authRequired"===e.status&&s.handleAuthRequired)s.handleAuthRequired(e);else{if(s.parse&&(e=s.parse(e)),!Array.isArray(e))for(var t in e)Array.isArray(e[t])&&(e=e[t]);var a=[],i=(_.each(e,function(e){var t,i;e&&(a.push(e[s.serverIdAttribute]),(t={})[s.serverIdAttribute]=e[s.serverIdAttribute]+"",t=s.findWhere(t),e.serverSetId=!0,t?(e[s.idAttribute]||(e[s.idAttribute]=t.get(s.idAttribute)),i=Math.max(t.get("modifiedServer")&&Date.parse(t.get("modifiedServer"))||0,t.get("modified")||0),(s.readOnly||!e.modifiedServer||Date.parse(e.modifiedServer)>i)&&t.save(e,{ignoreSave:!0,ignoreRender:!0})):(e[s.idAttribute]||(e[s.idAttribute]=e[s.serverIdAttribute]),s.create(e,{ignoreSave:!0,ignoreRender:!0}),e.archived||(n=!0)))}),s.models.slice());!1!==o.remove&&i.forEach(function(e){var t;e.get("serverSetId")&&a.indexOf(e.get(s.serverIdAttribute))<0&&!e.get("isDummy")&&!e.get("unsyncable")&&((t={})[s.idAttribute]=e.get([s.idAttribute])+"",(e=s.findWhere(t)).id=e.get(e.idAttribute),e.destroy({silent:!0}),n=!0)}),s.readOnly?(s.set(e,{silent:!0,remove:!0}),s.trigger("refresh"),s.setLoadedOnce()):(s.trigger("change",null,{ignoreSave:!0}),(n=s.setLoadedOnce()||n)&&s.trigger("refresh"),s.trigger("server-sync"),s.handleOrdering&&s.handleOrdering(e))}}).fail(function(e){e.responseJSON&&"authRequired"===e.responseJSON.status&&s.handleAuthRequired?s.handleAuthRequired(e.responseJSON):e.responseJSON&&"Microsoft Todo is not enabled for this account."===e.responseJSON.message.detail?m.$e.$emit("flashMessage",{icon:"data:image/svg+xml,%3Csvg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M64 32C64 49.6731 49.6731 64 32 64C14.3269 64 0 49.6731 0 32C0 14.3269 14.3269 0 32 0C49.6731 0 64 14.3269 64 32ZM28 46C28 43.7909 29.7909 42 32 42C34.2091 42 36 43.7909 36 46C36 48.2091 34.2091 50 32 50C29.7909 50 28 48.2091 28 46ZM32 15C29.7909 15 28 16.7909 28 19V33C28 35.2091 29.7909 37 32 37C34.2091 37 36 35.2091 36 33V19C36 16.7909 34.2091 15 32 15Z' /%3E%3C/svg%3E",contact:!1,message:"Oops, your Microsoft account does not support todos",button:{text:"Learn more",action:function(){m.utils.getBrowser().tabs.create({url:"https://go.microsoft.com/fwlink/?linkid=2153209"})}}}):t?t():!s.fetchedOnce&&o.error&&o.error(e)}).always(function(){e&&e()})))}}),m.models.TeamInfo=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("team-info"),defaults:{team:null,id:1},initialize:function(){this.fetch()}}),m.models.Message=Backbone.Model.extend({defaults:function(){return{title:null,message:"",recurringInterval:null,priority:5,views:0,viewLimit:3,deleted:!1,createdDate:m.now(),visible:!1,loginOnClick:!1,targetArea:null,important:!1,fromServer:!1,image_url:""}},showMessage:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},isTeamNotification:function(){return"team"===this.get("notification_type")},dismissMessage:function(){m.commandManager.execute("notification.dismiss")},save:function(e,t){if(t=t||{},(e=e||_.clone(this.attributes)).hasOwnProperty("dismissed")&&e.dismissed&&(e.deleted=!0),!t.download_save&&this.get("fromServer"))try{var i=null;for(prop in e)e.hasOwnProperty(prop)&&"changed_props"!=prop&&"sync_success"!=prop&&(i=i||this.get("changed_props")||[],_.contains(i,prop)||i.push(prop));i&&(e.changed_props=i,e.sync_success=!1,t.silent=!1)}catch(e){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.collect.Messages=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-messages"),model:m.models.Message,cleaned:!1,initialize:function(){this.listenTo(this,"reset",this.cleanupMessagesIfRequired)},cleanupMessagesIfRequired:function(){var i;this.cleaned||(this.cleaned=!0,i=[],this.each(function(e){var t;e.get("deleted")||e.get("expiry")&&!(Date.parse(e.get("expiry"))>m.now())?e.get("fromServer")&&e.get("sync_success")&&!e.get("changed_props")&&i.push(e):(t=e.get("filter"))&&m.conditionalFeatures.featureEnabled(t)?e.save({deleted:!0,filtered:!0}):5==e.get("priority")?e.get("fromServer")?e.save({deleted:!0}):i.push(e):e.get("visible")||e.save({deleted:!0})}),0<i.length&&_.each(i,function(e){e.destroy()}))}}),m.models.NotificationSync=Backbone.Model.extend({baseUrl:m.globals.urlRootApi+"notifications",initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"change:changed_props",this.onChange),this.listenTo(this.collection,"reset",this.onReset)},findHavingAttribute:function(e,t){return e.filter(function(e){return e.has(t)})},hasAttribute:function(e,t){return!!e.find(function(e){return e.has(t)})},onReset:function(){this.syncToServer()},onChange:function(e,t){t.ignoreSave||(t=e.changedAttributes())&&t.hasOwnProperty("changed_props")&&t.changed_props&&this.syncToServer()},syncToServer:function(e){var a=this,t=this.findHavingAttribute(this.collection,"changed_props");Promise.all(t.map(function(t){var e,i,n;if(t.get("fromServer"))return!(e=t.get("changed_props"))||0==e.length||(i={},_.each(e,function(e){"changed_props"!=e&&"sync_success"!=e&&(i[e]=t.get(e))}),1==Object.keys(i).length&&i.hasOwnProperty("views"))?Promise.resolve():(n=a.baseUrl+"/"+encodeURIComponent(t.id),new Promise(function(e){$.ajax({url:n,contentType:"application/json",type:"PATCH",data:JSON.stringify(i)}).done(function(e){e&&e.success&&t.save({changed_props:null,sync_success:!0},{silent:!0})}).fail(function(){t.save({sync_success:!1},{silent:!0})}).always(e)}))})).then(function(){e&&e()})}}),m.models.NotificationManager=Backbone.Model.extend({backgroundLoaded:!1,_notificationView:null,settingsVisible:!1,initialize:function(){this.displayed=[],this.collection=new m.collect.Messages,m.models.message=new m.models.Message,this.listenTo(this.collection,"add reset",this.displayPendingMessages),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"settings:hidden",this.settingsHidden),this.listenTo(m,"settings:visible",this.onSettingsVisible),this.listenTo(m,"notifications:timestamp",this.onAvailableTimestamp),this.listenTo(m,"appsReady",this.displayPendingMessages),m.conditionalFeatures.featureEnabled("notifySyncOff")||(this.notifySync=new m.models.NotificationSync({collection:this.collection})),this.collection.fetch({reset:!0})},onBackgroundLoaded:function(){this.backgroundLoaded||(this.backgroundLoaded=!0,this.displayPendingMessages(),m.commandManager.execute("clean.localstorage"))},displayPendingMessages:function(){var e,t,a=this;this.collection.cleanupMessagesIfRequired(),!m.reactive.appsReady||m.introductionActive||this.settingsVisible||!(e=this.notificationView())||e.notifying||m.reactive.modalLocked||m.reactive.onboardingRefreshing||(t=this.collection.where({deleted:!1,visible:!0}).filter(function(e){var t=e.get("filter"),i=e.get("recurringInterval"),n=e.get("lastDismissed");if((!t||!m.conditionalFeatures.featureEnabled(t))&&!(i&&n+i>(new Date).getTime())&&!(e.get("expiry")&&Date.parse(e.get("expiry"))<m.now())&&(!e.get("fromServer")||e.get("group_notification_id")))return!a.displayed.includes(e)}).sort(function(e,t){return e.get("priority")>t.get("priority")?1:e.get("priority")<t.get("priority")?-1:t.get("createdDate")-e.get("createdDate")}))&&0!==t.length&&(t=t[0],this.displayed.push(t),e.showMessage(t))},onAvailableTimestamp:function(e){var t;e&&(!(t=localStorage.getItem("ts_notifications"))||t<e)&&this.downloadNotifications()},downloadNotifications:function(){var t=this,e=localStorage.getItem("ts_notifications"),i=m.globals.urlRootApi+"notifications";e&&(e=parseInt(e,10),Number.isInteger(e))&&(i=i+"?ts="+e);try{$.ajax({type:"GET",contentType:"application/json",url:i}).done(function(e){e&&e.timestamp&&(e.notifications&&0<e.notifications.length&&(t.collection.reset(e.notifications),t.collection.invoke("save",null,{download_save:!0})),localStorage.setItem("ts_notifications",e.timestamp))})}catch(e){}},showMessage:function(e,t,i,n){e={title:e,message:t,visible:!0};void 0!==i&&(e.viewLimit=i),void 0!==n&&(e.loginOnClick=n),this.collection.create(e)},showMessageEnhanced:function(e,t,i){e.hasOwnProperty("visible")||(e.visible=!0);var n={};t&&(n.success=t),i&&(n.silent=!0),this.collection.create(e,n)},dismissMessage:function(){this._notificationView&&this.notificationView().hideNotification()},settingsHidden:function(){this.settingsVisible=!1,this.displayPendingMessages()},onSettingsVisible:function(){this.settingsVisible=!0},notificationView:function(){return this._notificationView||(this._notificationView=new m.views.Notification),this._notificationView}}),m.views.Notification=Backbone.View.extend({attributes:{class:"notification"},notifying:!1,timeoutId:null,analytics:new m.Analytics({feature:"notifications"}),areaMap:{settings:{selector:".app-container.settings .toggle-icon",targetDistance:15,position:"top-right",region:"bottom-left"},teamLogo:{position:"bottom-right",targetDistance:10,selector:"#team-logo",region:"top-left"},centerNav:{selector:'[data-ob="center-nav"]',targetDistance:15,position:"bottom-right",customCss:'[data-ob="center-nav"] > .icon { opacity: 1; } [data-ob="center-nav"]:after { background: rgba(255,255,255,0.2); }',region:"bottom-left"},addWidget:{selector:'[data-ob="add-metric"]',targetDistance:5,position:"bottom-left",region:"top-right",customCss:'[data-ob="add-metric"] { opacity: 1 !important; }'},soundscapes:{selector:'[data-ob="soundscapes"] [data-ob="app-dash"]',targetDistance:-10,position:"bottom-right",region:"top-left"},notes:{selector:".app-container.notes",position:"top-left",region:"bottom-right"},askAi:{selector:".app-container.chat",position:"top-left",region:"bottom-right"},searchCenter:{selector:".app-container.big.search .search-icon-container .icon-search",targetDistance:25,position:"top-right",region:"bottom-left"},tabStash:{selector:".app-container.tabs",position:"bottom-right",region:"top-left"},links:{selector:".app-container.links",position:"bottom-right",region:"top-left"}},initialize:function(){this.renderedOnce=!1,this.listenTo(m,"notification:hide",this.hideNotification),this.listenTo(m,"notification:dismiss",this.dismissNotification)},showMessage:function(e){var t;this.model&&this.model.cid==e.cid||(this.model=e,t=this,["cta_cmd","secondary_cmd"].forEach(function(e){e=t.model.get(e);e&&m.commandManager.beforeExecute(e)}),this.render())},render:function(){var e=this,t=(this.notifying=!0,this.incrementViews(),this.model.get("targetArea")),i=this.model.get("notification_type"),t=t||(i&&"momentum"!==i?"teamLogo":"settings"),i=this.areaMap[t],t={id:this.model.get("id"),headerText:this.model.get("title"),bodyText:this.model.get("message"),position:i.position,region:i.region,targetDistance:i.targetDistance,targetElementSelector:i.selector,ctaText:this.model.get("cta_text"),ctaCallback:this.model.get("cta_cmd")?this.ctaButtonClicked.bind(this):void 0,secondaryText:this.model.get("secondary_text"),secondaryCallback:this.model.get("secondary_text")?this.secondaryTextClicked.bind(this):void 0,hideCallback:this.hideNotificationClicked.bind(this),customCss:i.customCss,pulseAnimation:this.model.get("important"),imageUrl:this.model.get("image_url"),notificationStyling:{image_has_white_background:this.model.get("image_has_white_background")},onLeave:function(){m.models.notificationManager.displayPendingMessages()}},i=(m.cmd("modal.open",t),this.showNotification(),this.model.get("display_time"));!i||i<=0||(this.timeoutId=setTimeout(function(){e.hideNotification()},i))},incrementViews:function(){var e=this.model.get("views")+1;this.setModelCollection(),null!==this.model.get("viewLimit")&&(e>=this.model.get("viewLimit")?this.model.save({visible:!1,views:e}):this.model.save({views:e},{silent:!0}))},dismissNotification:function(){this.model&&(this.saveDismissal(),this.hideNotification())},showNotification:function(){this.analytics.capture("notification show",this.getIdsForAnalytics(this.model))},hideNotification:function(){clearTimeout(this.timeoutId),this.notifying&&(m.trigger("modal:close"),this.notifying=!1)},hideNotificationClicked:function(e){e&&e.stopPropagation(),this.hideNotification(),this.setModelCollection(),this.saveDismissal(),this.analytics.capture("notification dismiss",this.getIdsForAnalytics(this.model))},ctaButtonClicked:function(e){e&&e.stopPropagation();var e=this.model.get("cta_cmd"),t=this.model.get("cta_options");e&&0<e.length&&(this.setModelCollection(),this.hideNotification(),this.saveDismissal(!0),m.commandManager.execute(e,null,t),this.analytics.capture("primary cta click",this.getIdsForAnalytics(this.model)))},saveDismissal:function(e){var t=this.model.get("recurringInterval")?{lastDismissed:(new Date).getTime()}:{state:"dismissed",visible:!1};e&&(t.ctaClicked=m.now()),this.model.save(t,{silent:!0})},secondaryTextClicked:function(e){e&&e.stopPropagation();var e=this.model.get("secondary_cmd"),t=this.model.get("secondary_options");e&&0<e.length&&(this.setModelCollection(),this.model.save({secondaryClicked:m.now()},{silent:!0}),m.commandManager.execute(e,null,t),this.analytics.capture("secondary cta click",this.getIdsForAnalytics(this.model))),this.model.get("secondary_hide")&&this.hideNotification()},setModelCollection:function(){this.model.collection||(this.model.collection=m.models.notificationManager.collection)},getIdsForAnalytics:function(e){var t=e.get("group_notification_id"),i=e.get("title")?Array.from(e.get("title")).slice(0,19).join(""):"";return{title:e.isTeamNotification()?"[Redacted]":i,notification_id:t,group_id:e.get("campaign_group_id"),labels:(e.get("labels")||[]).join(", "),group_name:e.get("campaign_group_name")}}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()}}),m.commands.DismissSafariNotificationPermanently=m.models.Command.extend({defaults:{id:"notification.safariUpdate.dismissPermanently"},execute:function(){localStorage.setItem("notification:safariUpdate:dismissedPermanently",!0),m.models.notificationManager.dismissMessage();var e=m.models.notificationManager.collection.where({name:"safariUpdate"});e&&e.forEach(function(e){e.save({state:"dismissed",visible:!1},{silent:!0})})}}),m.commands.ShouldShowSafariVersionNotification=m.models.Command.extend({defaults:{id:"notification.safariUpdate.shouldShow"},execute:function(){var e=m.devTools&&m.devTools.forceSafariVersionNotificationCheck;return!("Safari"!==m.globals.platform&&!e||localStorage.getItem("notification:safariUpdate:dismissedPermanently"))&&(!!e||!!(e=/Version\/([0-9.]+)/.exec(navigator.userAgent))&&(e=parseFloat(e[1]))&&e<14.1)}}),m.commands.ShowSafariVersionNotification=m.models.Command.extend({defaults:{id:"notification.safariUpdate.show"},execute:function(){var e=m.models.notificationManager.collection.where({name:"safariUpdate",deleted:!1});e&&e.length||m.commandManager.execute("notification.show.enhanced",{name:"safariUpdate",id:"safariUpdate",title:"Not seeing Momentum as your start page?",message:"Update to the latest version of Safari to get the full experience.",priority:2,visible:!0,viewLimit:null,cta_text:"How to update",cta_cmd:"window.open",cta_options:{url:"https://support.apple.com/en-us/HT204416"},secondary_text:"Don't show this again",secondary_cmd:"notification.safariUpdate.dismissPermanently",recurringInterval:m.constants.msPerHour})}}),m.commands.EnableSearchInCenter=m.models.Command.extend({defaults:{id:"notification.searchInCenter.enable"},execute:function(){function e(){m.trigger("modal:show",Object.assign({},m.modals.definitions.searchInCenterNotification,{bodyText:"If you prefer to see your daily goal here, switch back using this button."}))}m.models.customization.get("centerBelowNavVisible")&&m.models.customization.get("searchVisible")?e():m.once("centerBelow:afterEnter",e),m.models.customization.save({searchVisible:!0,centerBelowNavVisible:!0,focusVisible:!1})}}),{flashInputLengthError:function(e){m.utils.toggleClassTwice(e,m.utils.mConst("classInputLengthError"))},checkForInputMaxLengthError:function(e){e.is("input")&&e.val().length>=e.attr("maxlength")&&m.settingsUtils.flashInputLengthError(e)},updateCharCount:function(e,t,i,n){var e=$(e.delegatedTarget.form),a=(n=n||e.find("input"),e.find(".char-count")),o=n.val().length,s=t.inputLengthMaxDatabase-o;a.text(s).removeClass("warn over"),a.mToggle("inline",o>=t.inputLengthShow),n.removeClass("over"),o>t.inputLengthMaxDatabase?(a.addClass("over"),n.addClass("over")):o>=t.inputLengthWarn&&a.addClass("warn"),i&&i(e,o,s)},moveCursorToEndOfInput:function(e){e=e[0];e.selectionStart=e.selectionEnd=e.value.length},scrollToEndOfInput:function(e){var t=e[0];t.scrollWidth>t.clientWidth&&(0!==e.scrollLeft()&&e.scrollLeft(0),e.scrollLeft(t.scrollWidth-t.clientWidth))},toggleAdvanced:function(e){var t=e.$(".wrapper-advanced"),i=e.$(".smooth-height-content");e.resizeSensorSet||(this.initializeResizeSensor(e,i,e.$(".smooth-height-wrapper")),e.resizeSensorSet=!0),i.toggleClass("active"),!e.wrapperAdvancedIsInFlow&&i.hasClass("active")&&(e.wrapperAdvancedIsInFlow=!0,t.css("display","block"))},initializeResizeSensor:function(e,t,i){e.resizeSensor&&e.resizeSensor.detach(),i.css("height",t.height()),e.resizeSensor=new ResizeSensor(t,function(){t.hasClass("active")?i.css("height",t.height()):i.css("height",0)})},getInitialFeedSettings:function(e){var t=!0,i=!1;return{feedMomentumClass:(t="false"===localStorage.getItem(e.feedMomentumName)?!1:t)?"on":"",feedCustomClass:(i="true"===localStorage.getItem(e.feedCustomName)?!0:i)?"on":""}},setFeedVars:function(e){e.$feedMomentumSlider=e.$("#feed-momentum-slider"),e.$feedCustomSlider=e.$("#feed-custom-slider")},updateFeedSettings:function(e){var t=e.settings.get(e.manager.feedMomentumName),i=e.settings.get(e.manager.feedCustomName);e.$("#feed-momentum-slider").toggleClass("on",t),e.$("#feed-custom-slider").toggleClass("on",i),localStorage.setItem(e.manager.feedMomentumName,t),localStorage.setItem(e.manager.feedCustomName,i)},subnavAddAll:function(t,i,e,n,a){_.each(t.subViews,function(e){e.destroy()}),t.subViews=[],t.collection.each(function(e){t.addOne(e,i)}),t.$empty.removeClass("loading"),t.handleCollectionUpdate(),void 0!==n&&n(t),e.removeClass("hidden"),void 0!==a&&a()},subnavAddOne:function(e,t,i,n,a){var o=t.render().$el;e.subViews.push(t),n?i.prepend(o):i.append(o),a&&o.addClass("animate-item"),setTimeout(function(){o.removeClass("animate-item")},300)},renderSubnav:function(e,t,i){e.$(".list-body").hide(),t.render(),e.$(".subnav-titles").find("h4").removeClass("active").siblings("."+i).addClass("active"),t.$el.css("display","block"),e.subnav=i},updateEmptyState:function(e){e.$empty.mToggle("block",0===e.collection.length)},subnavHistoryLoadMore:function(e,t,i){e.stopPropagation(),i.LoadMoreHistory(),m.settingsUtils.subnavHistoryUpdateLoadMore(t)},subnavHistoryUpdateLoadMore:function(e){(e=void 0===e?this:e).$(".load-more").mToggle("inline-block",!!e.collection.load_more)},handleCollectionUpdateCustom:function(e,t,i){e.deletingFinalItem?setTimeout(function(){e.deletingFinalItem=!1,e.cancelAdd(),m.settingsUtils.displayEmptyStateAndAddForm(e,t,i)},m.utils.mConst("timeContentItemAnimation")):m.settingsUtils.displayEmptyStateAndAddForm(e,t,i)},displayEmptyStateAndAddForm:function(e,t,i){t.mToggle("block",i),m.settingsUtils.updateAddFormBorder(e.$addForm,i)},updateAddFormBorder:function(e,t){e.toggleClass("no-top-border",t)},cancelAddGeneral:function(e,t){t&&t.preventDefault(),e.$addForm.is(":visible")&&(e.resetAdd(!0),e.toggleAddForm())},changeToEditMode:function(e,t){m.settingsUtils.triggerItemEditing(e),e.$el.addClass("editing"),t.trigger("focus"),m.settingsUtils.moveCursorToEndOfInput(t),m.settingsUtils.scrollToEndOfInput(t)},handleKeypressEnter:function(e,t,i){13===e.keyCode?(e.preventDefault(),e.shiftKey||e.ctrlKey||e.metaKey||e.altKey||t()):void 0!==i&&m.settingsUtils.checkForInputMaxLengthError(i)},handleKeyupEsc:function(e,t){27===e.keyCode&&(e.stopPropagation(),t())},triggerItemEditing:function(e){e.main.itemEditingId=e.model.id,e.manager.trigger("item-editing")},preventMultipleEdits:function(e){(e=void 0===e?this:e).model.id!==e.main.itemEditingId&&m.settingsUtils.returnToViewMode(e)},getOutOfEditMode:function(e){e.$el.removeClass("editing"),e.updateTooltip&&e.updateTooltip()},returnToViewMode:function(e){(e=void 0===e?this:e).$el.hasClass("editing")&&e.processEditForm(),e.$(".delete-group").is(":visible")&&e.toggleDeleteConf()},onDestroyModel:function(){var e;1===this.main.collection.length?(this.main.deletingFinalItem=!0,_.bind(this.destroy,this)()):(this.$el.addClass("animate-item reverse"),e=this,setTimeout(function(){_.bind(e.destroy,e)(),e.main.syncHelper&&e.main.syncHelper()},300))},toggleDeleteConf:function(e){var t=e.$(".controls"),i=e.$(".controls > .control"),n=e.$(".delete-group");n.css("display",n.is(":visible")?"none":"flex"),n.is(":visible")&&m.settingsUtils.triggerItemEditing(e),t.toggleClass("delete-clicked"),i.mToggle("inline-flex")},processEditFormBasic:function(e,t){var t=t?"set":"save",i=e.$input.val().trim();return m.utils.betweenInclusive(i.length,1,e.main.inputLengthMaxDatabase)?(e.model[t]({body:i},{wait:!0,patch:!0,success:function(){m.settingsUtils.getOutOfEditMode(e),e.manager.handleItemEdit(e.model)},error:function(){console.error("edit content item error for view:",e)}}),!0):(m.settingsUtils.flashInputLengthError(e.$input),!1)},abortEditBasic:function(e){e.$input.val(e.model.get("body")),m.settingsUtils.getOutOfEditMode(e)}});for(key in settingsUtils)m.settingsUtils[key]=settingsUtils[key];function sendUpsellClickEvent(e,t){(t=t||{}).source&&t.url&&(t.url+="&utm_campaign="+encodeURIComponent(t.source));var i=localStorage.getItem("offered-plan");t.url&&i&&m.conditionalFeatures.featureEnabled("notes-degraded")&&(t.url+="&resubscribe="+i)}function buildAccountLinkPathFromParameter(e){var t;return e&&(t=null,"string"==typeof e?t=e:"object"==typeof e&&e.path&&(t=e.path),t)?t.startsWith("/")?t.substring(1):t:null}function sendUpsellClickEvent(e,t){(t=t||{}).source&&t.url&&(t.url+="&utm_campaign="+encodeURIComponent(t.source));var i=localStorage.getItem("offered-plan");t.url&&i&&m.conditionalFeatures.featureEnabled("notes-degraded")&&(t.url+="&resubscribe="+i)}m.models.PersistentSettings=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaultForTeamIfNotSet:{themeColour:"photo"},defaultForPlusIfNotSet:{themeColour:"photo"},defaultIfNotSet:{mantraVisible:!1,greetingVisible:!0,quoteVisible:!0,bookmarksVisible:!1,linksVisible:!0,focusVisible:!0,todoVisible:!0,metricVisible:!0,weatherVisible:!0,searchVisible:!1,requestSync:!1,keepTodoState:!0,countdownVisible:!0,notesVisible:!0,notesFullscreen:!1,percentClock:!1,multiClockVisible:!0,soundscapesVisible:!0,askAiVisible:!1,linksKeepOpen:!1,themeColour:"system",autoFocus:!1,balanceModeStr:"",mantraSettingsStr:"",bookmarksSettingsStr:"",weatherDetail:!0,weatherHourly:!0,searchProvider:"bing",appRegionOverrides:{},hour12clock:"M"===(new Date).toLocaleString(window.navigator.userLanguage||window.navigator.language||"en-US").substr(-1),pomodoroSettingsStr:'{"autoplay":true,"hideSeconds":false,"focusDuration":25,"restDuration":5,"sounds":true}',clockVisible:!0,centerBelowNavVisible:!1,launchpadVisible:!1,linksMode:"list",tabsVisible:!0,focusModeVisible:!0,focusModeSettingsStr:JSON.stringify({apps:{pomodoro:{enabled:!0},tabStash:{enabled:!1},soundscapes:{enabled:!0,preset:"Random"}},oneClickFocus:!1})},initialize:function(){var t=this;t.fetching=!1,window.addEventListener("storage",function(e){e.key&&0===e.key.indexOf("momentum-customization-1")&&(t.fetching=!0,t.fetch({success:function(){t.fetching=!1},error:function(){t.fetching=!1},reset:!0,fromStorage:!0}))}),this.on("change:hour12clock",function(){m.models.date.set("date",m.date())})},get:function(e){var t=this.constructor.__super__.get.apply(this,arguments);if(null==t){var i=m.conditionalFeatures.featureEnabled("team"),n=m.conditionalFeatures.featureEnabled("plus"),a=this.defaultIfNotSet.hasOwnProperty(e),i=i&&this.defaultForTeamIfNotSet.hasOwnProperty(e),n=n&&this.defaultForPlusIfNotSet.hasOwnProperty(e);if(!a&&!i&&!n)return t;i?t=this.defaultForTeamIfNotSet[e]instanceof Function?this.defaultForTeamIfNotSet[e]():this.defaultForTeamIfNotSet[e]:n&&(t=this.defaultForPlusIfNotSet[e]instanceof Function?this.defaultForPlusIfNotSet[e]():this.defaultForPlusIfNotSet[e]),null==t&&a&&(t=this.defaultIfNotSet[e]instanceof Function?this.defaultIfNotSet[e]():this.defaultIfNotSet[e])}return t},save:function(){for(var e=!1,t=0;t++;){var i=arguments[t];i&&i.fromStorage&&(e=!0)}e||Backbone.Model.prototype.save.apply(this,arguments)}}),m.models.MantraManager=m.models.FeedManager.extend({activatingFirstMantra:!1,dateInitialized:null,defaults:{momo:!0,custom:!1},durationGreetingFirstTabOfDay:4e3,frequencyData:{durationGreeting:6e4,durationMantra:3e4,tabFrequency:2},frequencyLevels:[{level:0,label:"Rarely",durationGreeting:18e4,durationMantra:2e4,tabFrequency:8},{level:2,label:"Often",durationGreeting:45e3,durationMantra:3e4,tabFrequency:2},{level:3,label:"Always",durationGreeting:null,durationMantra:null,tabFrequency:null}],frequencyVariation:.25,keyHasSeenGreetingPrefix:"momentum-mantra-has-seen-greeting-",keyTabCountLegacy:"momentum-mantra-tab-count",keyTabCountPrefix:"momentum-mantra-tab-count-",showNameFrequency:.3,stringsThatPrecludeNames:[" I "," ME "," MINE "," MY ",". ",", ","; "],initialize:function(){m.models.FeedManager.prototype.initialize.call(this,m.models.Mantra,"mantra"),this.firstFetch(),this.settings=m.models.mantraSettings=new m.models.MantraSettings({id:1}),this.initializeMantraDailyData(),this.randomizeFrequency(),this.listenTo(this.itemCollection,"reset",this.onItemCollectionReset),this.listenTo(this,"mantra:deleted",this.handleMantraDelete),this.listenTo(m,"readyForWidgets",this.onSuccessfulLogin),this.listenTo(m,"newDay",this.onNewDayMantras),this.listenTo(m.models.mantraSettings,"change:frequency",this.onChangeFrequency),this.listenTo(m.models.customization,"change:mantraVisible",this.onChangeMantraVisible)},onItemCollectionReset:function(){this.trigger("mantra-active-change")},isEnabled:function(){return m.models.customization.getComputedSetting("mantraVisible")},toggleEnabled:function(){m.models.customization.toggle("mantraVisible")},hasSeenGreetingToday:function(){return JSON.parse(localStorage.getItem(this.keyHasSeenGreetingToday))},markGreetingAsSeenToday:function(){localStorage.setItem(this.keyHasSeenGreetingToday,"true")},isInAlternatingMode:function(){return!this.isFrequencyAlways()&&!this.isMantraPinned()},isFrequencyAlways:function(){return this.settings.getFrequency()===this.settings.frequencies.always},isMantraPinned:function(){return!!this.getPinnedMantra()},activeFeedsEmpty:function(){return this.itemCollection.empty()},updateInFeed:function(e){var t=this.itemCollection.findWhere({_id:e.get("_id")||e.get("id")});t&&(t.save({is_favorite:e.get("is_favorite"),body:e.get("body")}),t.get("_id")===this.getActiveItem().get("_id"))&&(this.getActiveItem().isPinned()&&this.savePinnedVars(t),this.trigger("mantra-active-edit"))},setActive:function(n){this.unpinMantra();var e=m.globals.urlRootApi+"settings/mantra/active",a=n.get("_id")||n.get("id"),o=this;return new Promise(function(t,i){$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({mantra_id:a}),url:e}).done(function(e){(e&&e.success?(o.getActiveItem().set({body:n.get("body"),_id:a,is_custom:n.get("is_custom"),is_favorite:n.get("is_favorite")}),m.trigger("sync:download","mantra"),t):i)(n)}).fail(function(){i(n)})})},onChangeMantraVisible:function(){this.activeFeedsEmpty()?(this.trigger("wait-for-mantra"),this.getActiveItem()):this.isEnabled()?this.randomizeFrequency():!0!==this.mantraDisablingInProgress&&(this.mantraDisablingInProgress=!0,this.unpinMantra(),this.mantraDisablingInProgress=!1,this.trigger("mantra-active-change"))},getDuration:function(e){return"greeting"===e?this.frequencyData.durationGreeting:"mantra"===e?this.frequencyData.durationMantra:void 0},getDurationTotal:function(){return this.frequencyData.durationGreeting+this.frequencyData.durationMantra},checkIfMantraShouldBeShown:function(){return!!localStorage.getItem("mantra:force")||!localStorage.getItem("greeting:force")&&!(!this.mantrasEnabledAndAvailable()||!this.hasSeenGreetingToday())&&(this.activatingFirstMantra?!(this.activatingFirstMantra=!1):!this.isInAlternatingMode()||this.checkMantraTabFrequency())},shouldShowMantraAfterGreetingFirstTabOfDay:function(){return this.mantrasEnabledAndAvailable()&&!this.hasSeenGreetingToday()&&!this.isInAlternatingMode()},mantrasEnabledAndAvailable:function(){return this.getActiveItem()&&this.isEnabled()},checkMantraTabFrequency:function(){var e=localStorage.getItem(this.keyTabCountToday)>=this.frequencyData.tabFrequency;return e&&this.resetTabCount(),e},onChangeFrequency:function(){this.resetAndRandomize(),this.isMantraPinned()&&this.unpinMantra(!0)},randomizeFrequency:function(){var e,t,i=this.lookupFrequencyBaseline();this.isFrequencyAlways()?(this.frequencyData.tabFrequency=i.tabFrequency,this.frequencyData.durationGreeting=i.durationGreeting,this.frequencyData.durationMantra=i.durationMantra):(e=1-this.frequencyVariation,t=1+this.frequencyVariation,this.frequencyData.tabFrequency=this.randomizeTabFrequency(i.tabFrequency),this.frequencyData.durationGreeting=m.utils.getRandomIntBetween(e*i.durationGreeting,t*i.durationGreeting),this.frequencyData.durationMantra=m.utils.getRandomIntBetween(e*i.durationMantra,t*i.durationMantra))},lookupFrequencyBaseline:function(){return _.where(this.frequencyLevels,{level:this.settings.getFrequency()})[0]},randomizeTabFrequency:function(e){var t=e*(1-this.frequencyVariation),i=e*(1+this.frequencyVariation);return i-t<2&&(t=2===e?2:e-1,i=e+1),m.utils.getRandomIntBetween(t,i)},initializeMantraDailyData:function(){m.models.cleanupManager.registerKey(this.keyTabCountLegacy),m.models.cleanupManager.registerKeyPrefix(this.keyTabCountPrefix,{pastDaysToKeep:0}),m.models.cleanupManager.registerKeyPrefix(this.keyHasSeenGreetingPrefix,{pastDaysToKeep:0});var e=m.utils.getDateString();this.dateInitialized=e,this.keyTabCountToday=this.keyTabCountPrefix+e,this.keyHasSeenGreetingToday=this.keyHasSeenGreetingPrefix+e;var t,e=parseInt(localStorage.getItem(this.keyTabCountToday));isNaN(e)?(t=1,localStorage.setItem(this.keyHasSeenGreetingToday,"false")):t=e+1,localStorage.setItem(this.keyTabCountToday,t)},resetTabCount:function(){localStorage.setItem(this.keyTabCountToday,"0")},resetAndRandomize:function(){this.resetTabCount(),this.randomizeFrequency()},onNewDayMantras:function(){this.tabWasLeftOvernight()&&(this.initializeMantraDailyData(),this.trigger("show-greeting"))},tabWasLeftOvernight:function(){return this.dateInitialized!==m.utils.getDateString()},getActiveItem:function(){var e,t=this,i=this.getPinnedMantra();return i?(e=this.itemCollection.findWhere({forDate:"pinned"}))&&e.get("_id")===i.id?e:this.itemCollection.create({forDate:"pinned",_id:i.id,body:i.body,is_custom:i.isCustom,is_favorite:i.isFavorite}):m.collect.mantras&&this.isEnabled()?(e=m.collect.mantras.getActiveItem())?e.get("hardSkip")?(this.noMantra=!0,null):(i=!1,this.currentMantra&&this.currentMantra.get("_id")===e.get("_id")&&this.currentMantra.get("body")===e.get("body")||(this.currentMantra=e,i=!0),i&&setTimeout(function(){m.trigger("mantra:active_changed",t.currentMantra.get("_id"))},50),e):(m.trigger("sync:download","mantra"),null):null},activateFirstMantra:function(){m.models.customization.save("mantraVisible",!0),this.settings.save({firstMantraActivated:!0}),this.getActiveItem(),this.activatingFirstMantra=!0,this.trigger("wait-for-mantra")},getPinnedMantra:function(){return this.settings?this.settings.get("pinnedMantra"):null},pinMantra:function(e,t){var i=this.getPinnedMantra(),n=e.get("_id")||e.get("id");return i&&n===i.id?(this.unpinMantra(!0),this.resetAndRandomize(),!1):(this.savePinnedVars(e,t),this.trigger("mantra-pin"),!0)},unpinMantra:function(e){this.isMantraPinned()&&this.settings.save({pinnedMantra:null});var t=m.collect.mantras.get("pinned");t&&t.destroy(),e&&this.trigger("mantra-un-pin")},savePinnedVars:function(e,t){var i=this.settings.get("pinnedMantra");i&&(t=t||i.showName),this.settings.save({pinnedMantra:{id:e.get("_id")||e.get("id"),body:e.get("body"),isFavorite:e.get("is_favorite"),isCustom:e.get("is_custom"),showName:t}})},toggleFav:function(e){var t=e.get("id")||e.get("_id");return this.feedContains(t)?this.toggleFavFeedItem(t):this.toggleFavorite(e.get("is_favorite"),e)},toggleFavFeedItem:function(i){var n=this,a=this.itemCollection.where({_id:i}),o=a[0].get("is_favorite"),s=!o,r=this.getPinnedMantra(),l=this.getActiveItem();return a.map(function(e){e.save({is_favorite:s})}),r&&i===r.id&&this.setPinnedProperty("isFavorite",s),l&&i===l.get("_id")&&this.trigger("mantra-active-fav"),new Promise(function(e,t){n.toggleFavorite(s,a[0]).then(function(){e()}).catch(function(){a.map(function(e){e.save({is_favorite:o})}),r&&i===r.id&&n.setPinnedProperty("isFavorite",o),l&&i===l.get("_id")&&n.trigger("mantra-active-fav"),t()})})},setPinnedProperty:function(e,t){var i=Object.assign({},this.settings.get("pinnedMantra"));i[e]=t,this.settings.save({pinnedMantra:i})},feedContains:function(e){return!!this.itemCollection.findWhere({_id:e})},handleMantraDelete:function(e){var t=this.getActiveItem();t&&t.get("_id")===e&&(t.isPinned()&&this.unpinMantra(),this.trigger("showGreeting"),m.trigger("sync:download","mantra"))},getMantraForDisplay:function(e,t){return e?(void 0!==this.showName&&t||(this.isMantraPinned()?this.showName=this.getPinnedMantra().showName:this.showName=m.utils.getRandomBoolByFrequency(this.showNameFrequency)),localStorage.getItem("mantra:forceName")&&(this.showName="true"===localStorage.getItem("mantra:forceName")),this.formatMantraForDisplay(e.get("body"),this.showName)):null},formatMantraForDisplay:function(e,t){e=e.trim();var i=m.utils.getEndPunctuationString(e),e=e.slice(0,e.length-i.length),n="";return t&&this.mantraWorksWithName(e)&&(e+=", ",n=m.models.customization.get("displayname"),m.utils.endsWithEndPunctuation(n))&&(i=""),{bodyFormatted:e+n+i,start:e,name:n,end:i}},mantraWorksWithName:function(e){var t,i=!0,n=m.models.customization.get("displayname").toUpperCase();if(!n)return!1;e=e.toUpperCase();for(var a=0;a<this.stringsThatPrecludeNames.length;a++)if(t=this.stringsThatPrecludeNames[a],-1!==e.indexOf(n)||-1!==e.indexOf(t)||e.startsWith(t.trim()+" ")||e.endsWith(" "+t.trim())){i=!1;break}return i},skipItem:function(e){return e&&!m.conditionalFeatures.featureEnabled("plus")&&(this.noMantra=!0),this.isMantraPinned()&&this.unpinMantra(),m.models.FeedManager.prototype.skipItem.apply(this,arguments)}}),m.models.MantraSettings=Backbone.Model.extend({defaults:{pinnedMantra:null,firstMantraActivated:!1,frequency:2},frequencies:{low:0,medium:2,high:2,always:3},initialize:function(){this.listenTo(m.models.customization,"change:mantraSettingsStr",this.customizationChanged),m.models.customization.initialized?this.customizationChanged():this.listenTo(m.models.customization,"initialized",this.customizationChanged)},customizationChanged:function(e,t){t&&t.savingMantraSettings||(t=m.models.customization.get("mantraSettingsStr"))&&t!==this.mantraSettingsStr&&0<t.length&&this.reset()},getFrequency:function(){var e=this.get("frequency"),t="string"==typeof e&&isNaN(+e)?this.frequencies[e]:"string"!=typeof e||isNaN(+e)?e:parseInt(e);return t=void 0===_.find(this.frequencies,function(e){return e===t})?this.defaults.frequency:t},reset:function(){this.mantraSettingsStr=m.models.customization.get("mantraSettingsStr");var t,i;this.mantraSettingsStr&&0<this.mantraSettingsStr.length&&(t=JSON.parse(this.mantraSettingsStr),i=this,["pinnedMantra","firstMantraActivated","frequency"].forEach(function(e){i.set(e,(void 0===t[e]?i.defaults:t)[e])}))},save:function(){Backbone.Model.prototype.set.apply(this,arguments),m.models.customization.initialized&&m.models.customization.save({mantraSettingsStr:JSON.stringify(this.attributes)},{savingMantraSettings:!0})},getFrequencyName:function(){var t=this.getFrequency(),i=this.frequencies;return Object.keys(i).find(function(e){return i[e]===t})}}),m.models.Settings=Backbone.Model.extend({defaults:{},initialize:function(){}}),m.models.GenericSettings=Backbone.Model.extend({initialize:function(e){this.feedType=e,this.urlPath="settings/"+e,this.url=m.globals.urlRoot+this.urlPath;e=localStorage.getItem("cached-"+this.urlPath);e&&this.set(JSON.parse(e)),this.listenTo(this,"sync",this.saveLocal)},saveLocal:function(){localStorage.setItem("cached-"+this.urlPath,JSON.stringify(this.attributes))},save:function(e,t){(t=t||{}).patch=!0;var n=this,a=t.success;t.success=function(e,t,i){n.saveLocal(),a&&a(e,t,i)},(m.isLoggedIn()?Backbone.Model.prototype.save:Backbone.Model.prototype.set).call(this,e,t),n.saveLocal()},toggle:function(e){var t={},i=(this.has(e)?t[e]=!this.get(e):t[e]=!0,{}),n=this;0<=e.indexOf("feed")&&(i.success=function(){m.trigger("sync:download",n.feedType)}),this.save(t,i)}}),m.models.BalanceMode=Backbone.Model.extend({defaults:{enabled:!1,active:!1,balanceClock:!1,balanceTodo:!1,balancePercentClock:!1,balanceFocus:!0,balanceNotes:!1,balanceGreeting:!1,customTime:!1,customDays:!1,start:{hour:9,minute:"00",noon:"AM"},end:{hour:5,minute:"00",noon:"PM"},startCustom:{hour:9,minute:"00",noon:"AM"},endCustom:{hour:5,minute:"00",noon:"PM"},days:[!1,!0,!0,!0,!0,!0,!1],daysCustom:[!1,!0,!0,!0,!0,!0,!1],percent:""},initialize:function(e,t){this.customization=t.customization||m.models.customization,this.updatePercent(),this.listenTo(this.customization,"change:balanceModeStr",this.customizationChanged),this.listenTo(this,"change:enabled",this.balanceChanged),this.listenTo(m.models.date,"change:date",this.checkBalance)},checkBalance:function(){var e=m.date(),t=this.getStart(),i=this.getEnd(),n=this.getDays(),t=t.hour+":"+t.minute+t.noon,i=i.hour+":"+i.minute+i.noon,a=this.get("active"),i=m.utils.toTodaysTime(i),t=m.utils.toTodaysTime(t),o=new Date(t.getTime()),s=(o.setDate(t.getDate()-1),new Date(i.getTime()));s.setDate(i.getDate()+1),this.set("active",this.get("enabled")&&(!n[e.getDay()]||i.getTime()>t.getTime()&&(t.getTime()>e.getTime()||e.getTime()>i.getTime())||i.getTime()<t.getTime()&&!(o.getTime()<e.getTime()&&e.getTime()<i.getTime()||t.getTime()<e.getTime()&&e.getTime()<s.getTime()))),a!==this.get("active")&&this.balanceChanged(),this.updatePercent()},customizationChanged:function(){var e=this.customization.get("balanceModeStr");e&&e!==this.balanceModeStr&&0<e.length&&this.resetBalanceMode()},resetBalanceMode:function(){var e;this.balanceModeStr=this.customization.get("balanceModeStr"),this.balanceModeStr&&0<this.balanceModeStr.length&&(e=JSON.parse(this.balanceModeStr),this.set("enabled",(void 0===e.enabled?this.defaults:e).enabled),this.set("start",e.start||this.defaults.start),this.set("end",e.end||this.defaults.end),this.set("days",e.days||this.defaults.days),this.set("customDays",(void 0===e.customDays?this.defaults:e).customDays),this.set("customTime",(void 0===e.customTime?this.defaults:e).customTime),this.set("startCustom",e.startCustom||this.defaults.startCustom),this.set("endCustom",e.endCustom||this.defaults.endCustom),this.set("daysCustom",e.daysCustom||this.defaults.daysCustom),this.set("balanceClock",(void 0===e.balanceClock?this.defaults:e).balanceClock),this.set("balanceFocus",(void 0===e.balanceFocus?this.defaults:e).balanceFocus),this.set("balanceTodo",(void 0===e.balanceTodo?this.defaults:e).balanceTodo),this.set("balanceGreeting",(void 0===e.balanceGreeting?this.defaults:e).balanceGreeting),this.set("balancePercentClock",(void 0===e.balancePercentClock?this.defaults:e).balancePercentClock),this.set("balanceNotes",(void 0===e.balanceNotes?this.defaults:e).balanceNotes),this.initCompleted=!0,this.checkBalance())},getDays:function(){return this.get("customDays")?this.get("daysCustom"):this.get("days")},getStart:function(){return this.get("customTime")?this.get("startCustom"):this.get("start")},getEnd:function(){return this.get("customTime")?this.get("endCustom"):this.get("end")},get:function(e){return!!("customDays"!==e&&"customTime"!==e||m.conditionalFeatures.featureEnabled("plus"))&&Backbone.Model.prototype.get.call(this,e)},balanceChanged:function(){this.initCompleted&&this.customization.save({balanceModeStr:JSON.stringify(this.attributes)})},updatePercent:function(){var e=this.getStart(),t=this.getEnd(),i=parseInt(e.hour),n=(12===i&&(i=0),parseInt(t.hour)),i=(12===n&&(n=0),i+("PM"===e.noon?12:0)),e=parseInt(e.minute),n=n+("PM"===t.noon?12:0),t=parseInt(t.minute)-1,a=(24<n-i&&(n-=24),m.date()),o=m.date(),s=(o.setHours(i,e,0,0),m.date()),s=(s.setHours(n,t,0,0),o.getTime()>s.getTime()&&(a.getTime()<=s.getTime()?i-=24:n+=24),o.setHours(i,e,0,0),s.setHours(n,t,0,0),60*(n+t/60-(i+e/60))*60),n=(a.getTime()-o.getTime())/1e3,t=Math.floor(n/s*100);this.set("percent",t=100<t?"+"+(t-100):t)}}),m.models.BookmarksSettings=Backbone.Model.extend({defaults:{guided:!1,iconsOnly:!1,openInNewTab:!1,includeBookmarks:!1,includeOtherBookmarks:!1,defaultMostVisited:!1,includeMostVisited:!0,chromeTabLocation:"links"},initialize:function(){this.listenTo(m.models.customization,"change:bookmarksSettingsStr",this.customizationChanged),this.permissions={permissions:["bookmarks","topSites"]},m.utils.isChrome()&&(this.permissions.origins=["chrome://favicon/"])},customizationChanged:function(){var e=m.models.customization.get("bookmarksSettingsStr");e&&e!=this.bookmarksSettingsStr&&0<e.length&&this.reset()},reset:function(){this.bookmarksSettingsStr=m.models.customization.get("bookmarksSettingsStr");var t,i;this.bookmarksSettingsStr&&0<this.bookmarksSettingsStr.length&&(t=JSON.parse(this.bookmarksSettingsStr),i=this,["iconsOnly","openInNewTab","includeBookmarks","includeOtherBookmarks","defaultMostVisited","includeMostVisited","chromeTabLocation","guided"].forEach(function(e){i.set(e,(null==t[e]?i.defaults:t)[e])}),localStorage.setItem("bookmarksEnabled",m.models.customization.get("bookmarksVisible")))},optionsChanged:function(e,t){var i=m.models.customization;i.save({bookmarksSettingsStr:JSON.stringify(this.attributes)}),e&&i.save(e,t)}}),m.models.ComputedSettings=Backbone.Model.extend({defaults:{percentClock:!1,todoVisible:!1,focusVisible:!1,greetingVisible:!1,autoFocus:!1,clockVisible:!0,notesVisible:!1},settingOverriders:{TEAM:0,BALANCE:1},overrides:{},initializeSettings:function(){var t=this;this.persistentSettings=new m.models.PersistentSettings({id:1}),this.listenTo(this.persistentSettings,"change",this.computeProperties),this.listenTo(this.persistentSettings,"sync",function(){var e=t.persistentSettings.get("balanceModeStr");e&&0<e.length&&(m.models.balanceMode.resetBalanceMode(),t.computeProperties()),t.initialized||(t.initialized=!0,t.updateSearchSettings(),t.trigger("initialized"))}),m.conditionalFeatures=new m.models.ConditionalFeatures({},{customization:this}),m.models.balanceMode=this.balanceMode=new m.models.BalanceMode({id:1},{customization:this}),m.models.bookmarksSettings=new m.models.BookmarksSettings({id:1}),this.persistentSettings.fetch({error:function(e,t){"Record Not Found"==t&&e.save()}})},updateSearchSettings:function(){var e,t;m.isLoggedIn()||!(t=localStorage.getItem("client_uuid"))||0===t.length||"0"!==(t=t.toLowerCase())[0]&&"1"!==t[0]||this.persistentSettings.get("searchUpdated")||(t={searchUpdated:!0,searchVisible:null},"google"!==(e=this.persistentSettings.get("searchProvider"))&&"bing"!==e&&(t.searchProvider=null),this.persistentSettings.save(t))},checkBalanceMode:function(e,t,i){var n=this.attributes[e],i=!!i||!this.persistentSettings.has(e)||this.persistentSettings.get(e);this.attributes[e]=i&&!(m.models.balanceMode.get("active")&&m.models.balanceMode.get(t)),this.persistentSettings.get(e)!==this.attributes[e]&&(this.overrides[e]=this.settingOverriders.BALANCE),n!==this.attributes[e]&&this.trigger("change:"+e)},checkTeamOverride:function(e,t){var i,n,a=m.models.teamInfo.get("team");a&&(i=this.attributes[e],n=this.persistentSettings.get(e),this.attributes[e]=n||!a[t],n!==this.attributes[e]&&(this.overrides[e]=this.settingOverriders.TEAM),i!==this.attributes[e])&&this.trigger("change:"+e)},checkAutoFocus:function(){var e="autoFocus",t=this.attributes[e];return this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),t!==this.attributes[e]},checkTemporaryOverride:function(){var t=this,i=(Object.entries(m.reactive.visibilityOverride).forEach(function(e){t.attributes[e[0]]=e[1],t.trigger("visibilityOverride:"+e[0])}),[]);Object.keys(this.attributes).forEach(function(e){"id"!==e&&(Object.keys(m.reactive.visibilityOverride).includes(e)||Object.keys(t.defaults).includes(e)||delete t.attributes[e],i.push(e))}),m.trigger("customization:update",i)},computeProperties:function(t,i,n){var a=this;this.checkBalanceMode("todoVisible","balanceTodo"),this.checkBalanceMode("greetingVisible","balanceGreeting"),this.checkBalanceMode("percentClock","balancePercentClock"),this.checkBalanceMode("clockVisible","balanceClock"),this.checkBalanceMode("focusVisible","balanceFocus"),this.checkBalanceMode("notesVisible","balanceNotes"),this.checkTeamOverride("focusVisible","focusEmpty"),this.checkTeamOverride("multiClockVisible","clocksEmpty"),this.checkTeamOverride("metricVisible","metricsEmpty"),this.checkTeamOverride("countdownVisible","countdownsEmpty"),this.checkTemporaryOverride();var e=(e=this.persistentSettings.changedAttributes())||{};this.checkAutoFocus()&&!e.autoFocus&&(e.autoFocus=this.attributes.autoFocus),_.keys(e).forEach(function(e){a.trigger("change:"+e,t,i,n)}),this.trigger("change",t,i,n)},get:function(e){return this.persistentSettings.get(e)},getPersistentSettings:function(){return this.persistentSettings},getComputedSetting:function(e){var t=Backbone.Model.prototype.get.call(this,e);return void 0!==t?t:this.persistentSettings.get(e)},set:function(){arguments[0].id?Backbone.Model.prototype.set.apply(this,arguments):this.persistentSettings.set.apply(this.persistentSettings,arguments)},save:function(){this.persistentSettings.save.apply(this.persistentSettings,arguments)},clear:function(){this.persistentSettings.clear.apply(this.persistentSettings,arguments)},fetch:function(){this.persistentSettings.fetch.apply(this.persistentSettings,arguments)},toggle:function(e){var t,i;e&&(t=!this.get(e),(i={})[e]=t,this.save(i))}}),m.collect.Mantras=Backbone.Collection.extend({loadedOnce:!1,initialize:function(){this.model=m.models.Mantra,this.collectionName="momentum-mantra",this.localStorage=new Backbone.LocalStorage(this.collectionName),this.listenToOnce(this,"reset",this.onReset)},getActiveItem:function(){var e;if(0<this.length)return e=m.utils.getDateString(),this.get(e)},onReset:function(){this.loadedOnce=!0},empty:function(){return 0===this.models.length}}),m.collect.Settings=Backbone.Collection.extend({saveOptions:{patch:!0},initialize:function(){this.model=m.models.Settings}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"settings",class:"app-container settings","data-test":"settings"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden),this.visible=!1,this.$el.clickOutside(this,this.hideSettings)},render:function(){var e,t;return this.renderedOnce||(e='<span class="app-dash toggle" data-test="settings-toggle" data-ob="settings-toggle">'+(m.utils.isSafari()?'<svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="white"><path d="M490.667 405.333h-56.811C424.619 374.592 396.373 352 362.667 352s-61.931 22.592-71.189 53.333H21.333C9.557 405.333 0 414.891 0 426.667S9.557 448 21.333 448h270.144c9.237 30.741 37.483 53.333 71.189 53.333s61.931-22.592 71.189-53.333h56.811c11.797 0 21.333-9.557 21.333-21.333s-9.535-21.334-21.332-21.334zm-128 53.334c-17.643 0-32-14.357-32-32s14.357-32 32-32 32 14.357 32 32-14.358 32-32 32zM490.667 64h-56.811c-9.259-30.741-37.483-53.333-71.189-53.333S300.736 33.259 291.477 64H21.333C9.557 64 0 73.557 0 85.333s9.557 21.333 21.333 21.333h270.144C300.736 137.408 328.96 160 362.667 160s61.931-22.592 71.189-53.333h56.811c11.797 0 21.333-9.557 21.333-21.333S502.464 64 490.667 64zm-128 53.333c-17.643 0-32-14.357-32-32s14.357-32 32-32 32 14.357 32 32-14.358 32-32 32zM490.667 234.667H220.523c-9.259-30.741-37.483-53.333-71.189-53.333s-61.931 22.592-71.189 53.333H21.333C9.557 234.667 0 244.224 0 256c0 11.776 9.557 21.333 21.333 21.333h56.811c9.259 30.741 37.483 53.333 71.189 53.333s61.931-22.592 71.189-53.333h270.144c11.797 0 21.333-9.557 21.333-21.333.001-11.776-9.535-21.333-21.332-21.333zM149.333 288c-17.643 0-32-14.357-32-32s14.357-32 32-32 32 14.357 32 32-14.357 32-32 32z"/></svg>':'<svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg>')+"</span>",t=(this.options.order||"append")+"To",this.$el[t]("."+this.options.region).html(e),this.renderedOnce=!0),this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),this.visible?m.commandManager.execute("settings.toggle"):this.initializeSettings().then(function(){m.commandManager.execute("settings.toggle")})},initializeSettings:function(){var t=this;return new Promise(function(e){t.initialized?e():(this.initialized=!0,m.commandManager.ensureCommandLoaded("settings.initialize",function(){t.mainSettings=m.commandManager.execute("settings.initialize",t.$el),setTimeout(function(){e()},50)}))})},hideSettings:function(e){m.upsellModalActive||e==this||e&&e.originalEvent&&"click"===e.type&&e.target&&this.mainSettings&&$.contains(this.mainSettings.el,e.target)||(m.commandManager.execute("settings.hide"),this.visible=!1)},settingsVisible:function(){this.$el.addClass("show").width(),this.$el.addClass("show-fade-in"),this.visible=!0},settingsHidden:function(e){var t;e&&e.preventDefault(),this.$el.hasClass("show")&&(this.visible=!1,(t=this).$el.removeClass("show-fade-in").on("transitionend webkitTransitionEnd",function e(){t.$el.removeClass("show"),t.$el.off("transitionend webkitTransitionEnd",e)}))}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){return m.widgetManager.getWidget(e.targetRegion).showUpsell(e)}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t){(t=t||(e&&e.source?e:{})).url="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic",sendUpsellClickEvent(e,t),m.commandManager.execute("window.open",null,{url:t.url})}}),m.commands.UpsellModal=m.models.Command.extend({defaults:{id:"upsell.modal"},execute:function(e,t){sendUpsellClickEvent(e,t),t&&t.skipPlusFeatures?m.cmd("modal.open","UPGRADE"):m.cmd("modal.open","PLUS_GATE")}}),m.commands.UpsellUpgrade=m.models.Command.extend({defaults:{id:"upsell.upgrade"},execute:function(e){m.commandManager.execute("upsell.modal",null,e),m.Analytics.capture("upsell click",{feature:"settings"})}}),m.models.Mantra=Backbone.Model.extend({idAttribute:"forDate",defaults:function(){return{body:"New Mantra",type:"mantra",is_favorite:!1}},save:function(e,t){(t=t||{}).update=!0,Backbone.Model.prototype.save.call(this,e,t)},isPinned:function(){var e=m.models.mantraManager.getPinnedMantra();return!!e&&this.get("_id")===e.id}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){m.commandManager.execute("auth.connect.provider",e.actionParameter,function(){m.trigger("todoListManager:fetch")})}}),m.commands.AuthConnectProvider=m.models.Command.extend({defaults:{id:"auth.connect.provider"},execute:function(e,t,i){var n,a,o,s,r,l,d,c,u,g,h;e&&e.status&&"authRequired"===e.status&&e.authorizationUrl?(n=e.winWidth||600,a=e.winHeight||510,l=e.windowFeatures||"titlebar,resizable,status",d=window.screen.width/2-n/2,o=window.screen.height/2-a/2,s=window.open(e.authorizationUrl,"MomentumAuthWindow",l+",left="+d+",top="+o+",width="+n+",height="+a),r=function(){s.closed||setTimeout(function(){s.closed||s.close()},1e3),t&&t()},l=e.authorizationUrl.split("/"),d="",1<l.length&&(d=l[l.length-1]),c=m.globals.urlRootApi+"user/auth/status/"+d,u=0,g=1e3,(h=function(){s.closed?r():100<++u||(u%30&&(g+=1e3),$.ajax({type:"GET",contentType:"application/json",url:c}).done(function(e){e&&e.token_obtained?r():setTimeout(function(){h()},g)}).fail(function(){setTimeout(function(){h()},g)}))})()):i&&i()}}),m.commands.ToggleAutoFocus=m.models.Command.extend({defaults:{id:"todo.toggle.autofocus"},execute:function(e,t){if(m.conditionalFeatures.featureEnabled("pinfocus"))return m.Analytics.capture(m.models.customization.get("autoFocus")?"autofocus disable":"autofocus enable",{feature:"focus",location:t.sourceApp.toLowerCase(),is_paid_event:!0}),m.models.customization.toggle("autoFocus"),m.trigger("toggleAutoFocus",m.models.customization.get("autoFocus")),!1;m.cmd("modal.open","UPSELL_AUTOFOCUS",{eventSource:t&&t.eventSource})}}),m.commands.CleanLocalStorage=m.models.Command.extend({defaults:{id:"clean.localstorage"},initialize:function(){this.twoDaysAgo=m.now()-1728e5},execute:function(){var a,o=this;localStorage.getItem("last_cleanup")>this.twoDaysAgo||(a=setTimeout(function(){try{if(m&&m.collect&&m.collect.backgrounds){clearTimeout(a);for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,"archived-"==(i=localStorage.key(n)).substring(0,9)&&(t=!0),"fallback-"==i.substring(0,9)&&(t=!0),"image_displayed-"==i.substring(0,16)&&(t=!0),"weather-loc-"==i.substring(0,12)?t=!0:"ddl-bg-"==i.substring(0,7)?localStorage.getItem(i)<o.twoDaysAgo&&(t=!0):"ddl-qt-"==i.substring(0,7)&&localStorage.getItem(i)<o.twoDaysAgo&&(t=!0),t&&e.push(i);for(n=0;n<e.length;n++)localStorage.removeItem(e[n]);m.commandManager.execute("clean.localstorage.addin"),localStorage.setItem("last_cleanup",m.now())}}catch(e){}},500))},collectionCleaner:function(e,t){var i=this;if(e){t=t||"forDate",entriesToClean=[],e.each(function(e){e=e.get(t);Date.parse(e)<i.twoDaysAgo&&entriesToClean.push(e)});for(var n=0;n<entriesToClean.length;n++)e.get(entriesToClean[n]).destroy();return entriesToClean.length}return 0}}),m.commands.CleanupUserData=m.models.Command.extend({defaults:{id:"user.cleanup"},execute:function(e,t){e&&e.type&&("notifications"==e.type?this.cleanNotifications():"all"==e.type&&(this.cleanUserData(),this.managerCleanup(m),this.managerCleanup(m.models))),t&&t()},managerCleanup:function(e){var t=Object.keys(e);for(i in t){var n=t[i];m.hasOwnProperty(n)&&((n=m[n])instanceof m.models.Manager||n instanceof m.collect.Manager)&&n.cleanup&&n.cleanup()}},cleanNotifications:function(){for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,(t=(i=localStorage.key(n)).startsWith("momentum-messages")||"ts_notifications"==i?!0:t)&&e.push(i);for(n=0;n<e.length;n++)localStorage.removeItem(e[n])},cleanUserData:function(){for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,(t="notes"==(i=localStorage.key(n))||i.endsWith("-loaded-once")||i.startsWith("teamFocus")||i.startsWith("team-info")||i.startsWith("cached-steam")||i.startsWith("no-background")||i.startsWith("no-quote")||i.startsWith("no-mantra")||i.startsWith("quicklinks")||i.startsWith("teamlinks")||i.startsWith("todo")||i.startsWith("focus")||i.startsWith("countdown")||i.startsWith("clock")||i.startsWith("metrics")||i.startsWith("momentum-messages")||i.startsWith("momentum-mantra")||i.startsWith("momentum-quote")||i.startsWith("momentum-background")||i.startsWith("momentum-pinned")||i.startsWith("ddl-")||i.startsWith("cached-settings")||i.startsWith("activeTodo")||i.startsWith("cached-team")||i.startsWith("listCache")||"notes-"==i.substring(0,6)||"cachedTodoProviders"==i||"cachedFocus"==i||"f3t6b23d"==i||"current-countdown"==i||"loginParams"==i||"pendingLoginState"==i||"clocks"==i||"clocks-"==i.substring(0,7)||"activeTodoProvider"==i||"activeTodoListId-"==i.substring(0,17)||"font-"==i.substring(0,5)||"listCache-"==i.substring(0,10)||"projectCache-"==i.substring(0,13)||"tsCachedTodoProviders"==i||"ts_notifications"==i||"todos-updated"==i||i.includes("activeTodo")||"showTodoList"===i?!0:t)&&e.push(i);var a=JSON.parse(localStorage.getItem("momentum-customization-1"));delete a.etag,localStorage.setItem("momentum-customization-1",JSON.stringify(a));for(n=0;n<e.length;n++)localStorage.removeItem(e[n])}}),m.commands.LoadAddins=m.models.Command.extend({defaults:{id:"addins.load"},execute:function(e){if(e){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.length;i++){var t=e[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}}),m.commands.AccountLogin=m.models.Command.extend({defaults:{id:"account.login"},execute:function(){m.isLoggedIn()?m.commandManager.execute("notification.show.enhanced",{message:"You are already logged in.",display_time:5e3,viewLimit:1,priority:2}):(m.commandManager.execute("user.cleanup",{type:"notifications"}),localStorage.doLoginOnNextLoad=!0,window.location.reload())}}),m.commands.Logout=m.models.Command.extend({defaults:{id:"logout"},execute:function(t){var e={token:localStorage.token,token_uuid:localStorage.token_uuid};function i(){var e;t&&t.keepData?(localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),localStorage.removeItem("userId"),m.conditionalFeatures.clearFeatures(),e=t&&t.token_invalid_reason,localStorage.setItem("loggedOut",m.now()),e=e||"You have been logged out.",m.commandManager.execute("notification.show.enhanced",{message:e,display_time:5e3,viewLimit:1,priority:2},function(){window.location.reload()},!0)):m.utils.clearStorage().finally(function(){m.$e.sendCrossTabMessage("reload"),window.location.reload()})}$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(e),url:m.globals.urlRootLogin+"user/logout"}).always(function(){m.utils.isSafari()&&window.browser&&window.browser.runtime?browser.runtime.sendNativeMessage("com.momentumdash.momentum.safari",{eventName:"removeUserTokenInfo"}).then(function(){i()}):i()})}}),m.commands.openModal=m.models.Command.extend({defaults:{id:"modal.open"},execute:function(t,i){var n=(i=void 0===i?{}:i).subStepIndex,a=i.force;function e(){var e="object"==typeof t?t:m.modals.definitions[m.modals.stepsEnum[t]];e?(Object.assign(e,i),!e.id.startsWith("upsell")&&"plusGate"!==e.id||(a=!0),m.trigger("modal:show",e,{subStepIndex:n,force:a})):console.warn("No step: "+t+" found in onboarding definitions")}delete i.subStepIndex,delete i.force,m.modals?e():m.on("modalContainer:created",e)}}),m.commands.openModalFromNotification=m.models.Command.extend({defaults:{id:"modal.openFromNotification"},execute:function(e,t){void 0===(t=void 0===t?{}:t).options&&(t.options={}),t.options.force=!0,m.cmd("modal.open",t.step,t.options)}}),m.commands.SyncEnable=m.models.Command.extend({defaults:{id:"sync.enable"},execute:function(){m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")||m.isLoggedIn()&&m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){window.location.reload()},function(){m.commandManager.execute("notification.show.enhanced",{message:"Unable to enable account sync. Reload the tab and try again, or check our help site.",viewLimit:1,priority:2})})}}),m.commands.ThirdPartyAuthConnect=m.models.Command.extend({defaults:{id:"auth.thirdparty"},execute:function(e,t){this.initiateThirdPartyLogin(e,t)},initiateThirdPartyLogin:function(e,t){var i,e=localStorage.email,n=m.utils.getBrowserName(),a="chrome-extension";"Chrome"===n&&(i=chrome.runtime.getURL("/login.html")),"Firefox"===n&&(a="firefox-extension",i=browser.runtime.getURL("/login.html")),this.loading||(this.loading=!0,$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({email:e,medium:a,mediumURL:i}),url:m.globals.urlRootLogin+"login/sso"}).done(function(e){e?(localStorage.setItem("pendingLoginState",JSON.stringify(e)),e.redirectUrl&&(window.location.href=e.redirectUrl)):t&&t()}).fail(function(){t&&t()}))}}),m.commands.WindowNavigate=m.models.Command.extend({defaults:{id:"window.navigate"},execute:function(e,t){var i;t&&(i=null,t.url&&(i=t.url),i=e&&t.urlField?e.get(t.urlField):i)&&(window.location.href=i)}}),m.commands.WindowOpen=m.models.Command.extend({defaults:{id:"window.open"},execute:function(e,t){var i;t&&(i=null,t.url&&(i=t.url),i=e&&t.urlField?e.get(t.urlField):i)&&window.open(i,t.windowName||"_blank")}}),m.commands.WindowAccountOpen=m.models.Command.extend({defaults:{id:"window.account.open"},execute:function(e){var t=buildAccountLinkPathFromParameter(e,!1),e=e.windowName||"_blank";null!=t&&(t=m.globals.urlRootAccount+t,window.open(t,e))}}),m.commands.WindowAccountOpenLogin=m.models.Command.extend({defaults:{id:"window.account.open.login"},execute:function(e){var t,i,n,a=buildAccountLinkPathFromParameter(e,!1),o=e.windowName||"_blank";function s(){var e=m.globals.urlRootAccount+a;window.open(e,o)}null!=a&&(t=localStorage.getItem("userId"),i="Safari"===m.utils.getBrowserName()?window.open("loading.html",o):null,t&&localStorage.getItem("login-state-account")!==t?(n=localStorage.getItem("unregistered"),$.ajax({type:"POST",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify({medium:"account"}),url:m.globals.urlRootApi+"login/onetime"}).done(function(e){e=e&&e.otp?m.globals.urlRootAccount+(n?"onetime?uuid="+localStorage.getItem("userId"):"onetime?email="+encodeURIComponent(e.email))+"&otp="+encodeURIComponent(e.otp)+"&redirect="+a:m.globals.urlRootAccount;i?i.location=e:window.open(e,"_blank")}).fail(function(){s()}).always(e&&e.callback)):s())}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()}}),m.commands.DismissSafariNotificationPermanently=m.models.Command.extend({defaults:{id:"notification.safariUpdate.dismissPermanently"},execute:function(){localStorage.setItem("notification:safariUpdate:dismissedPermanently",!0),m.models.notificationManager.dismissMessage();var e=m.models.notificationManager.collection.where({name:"safariUpdate"});e&&e.forEach(function(e){e.save({state:"dismissed",visible:!1},{silent:!0})})}}),m.commands.ShouldShowSafariVersionNotification=m.models.Command.extend({defaults:{id:"notification.safariUpdate.shouldShow"},execute:function(){var e=m.devTools&&m.devTools.forceSafariVersionNotificationCheck;return!("Safari"!==m.globals.platform&&!e||localStorage.getItem("notification:safariUpdate:dismissedPermanently"))&&(!!e||!!(e=/Version\/([0-9.]+)/.exec(navigator.userAgent))&&(e=parseFloat(e[1]))&&e<14.1)}}),m.commands.ShowSafariVersionNotification=m.models.Command.extend({defaults:{id:"notification.safariUpdate.show"},execute:function(){var e=m.models.notificationManager.collection.where({name:"safariUpdate",deleted:!1});e&&e.length||m.commandManager.execute("notification.show.enhanced",{name:"safariUpdate",id:"safariUpdate",title:"Not seeing Momentum as your start page?",message:"Update to the latest version of Safari to get the full experience.",priority:2,visible:!0,viewLimit:null,cta_text:"How to update",cta_cmd:"window.open",cta_options:{url:"https://support.apple.com/en-us/HT204416"},secondary_text:"Don't show this again",secondary_cmd:"notification.safariUpdate.dismissPermanently",recurringInterval:m.constants.msPerHour})}}),m.commands.EnableSearchInCenter=m.models.Command.extend({defaults:{id:"notification.searchInCenter.enable"},execute:function(){function e(){m.trigger("modal:show",Object.assign({},m.modals.definitions.searchInCenterNotification,{bodyText:"If you prefer to see your daily goal here, switch back using this button."}))}m.models.customization.get("centerBelowNavVisible")&&m.models.customization.get("searchVisible")?e():m.once("centerBelow:afterEnter",e),m.models.customization.save({searchVisible:!0,centerBelowNavVisible:!0,focusVisible:!1})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){return m.widgetManager.getWidget(e.targetRegion).showUpsell(e)}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t){(t=t||(e&&e.source?e:{})).url="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic",sendUpsellClickEvent(e,t),m.commandManager.execute("window.open",null,{url:t.url})}}),m.commands.UpsellModal=m.models.Command.extend({defaults:{id:"upsell.modal"},execute:function(e,t){sendUpsellClickEvent(e,t),t&&t.skipPlusFeatures?m.cmd("modal.open","UPGRADE"):m.cmd("modal.open","PLUS_GATE")}}),m.commands.UpsellUpgrade=m.models.Command.extend({defaults:{id:"upsell.upgrade"},execute:function(e){m.commandManager.execute("upsell.modal",null,e),m.Analytics.capture("upsell click",{feature:"settings"})}}),m.models.Date=Backbone.Model.extend({defaults:function(){var e=m.date();return{date:e,seconds:e}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this),this.listenTo(m,"globalEvent:pageShown",this.onPageShown)},setDateUpdateTimer:function(){var e=this,t=m.date(),i=t.getSeconds(),t=t.getMilliseconds();setTimeout(function(){e.set("date",m.date()),e.setDateUpdateTimer()},6e4-1e3*i-t)},setSecondsUpdateTimer:function(){var i=this,n=Date.now();!function e(){var t=Date.now()-n;n+=1e3;i.set("seconds",m.date());setTimeout(e,Math.max(0,1e3-t))}()},getTimeString:function(e){var t=m.models.customization.get("hour12clock"),i=(e=e||this.get("date")).getHours(),e=e.getMinutes();return(i=(i=1==t?(i+11)%12+1:i)<10&&!t?"0"+i:i)+":"+(e=e<10?"0"+e:e)},getTimePeriod:function(){return 12<=this.get("date").getHours()?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!==e&&this.set("time",e)},onPageShown:function(){var e=this.get("time"),t=this.getTimeString(new Date);void 0!==e&&e!==t&&this.set("date",m.date())}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){this.$loading=$('<span class="message-fill"><i class="loading-icon"></i> Loading...</span>'),m.console.log(m.elapsed()+": Dashboard Init"),m.models.themeManager=new m.models.ThemeManager,m.models.customization.fetch({error:function(){m.models.customization.save(),m.models.themeManager.initializeThemes()},success:function(){m.models.themeManager.initializeThemes()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.backgroundManager=new m.models.BackgroundManager,m.conditionalFeatures.featureEnabled("team")&&$("body").addClass("has-team"),m.models.backgroundManager.firstFetch(),m.models.notificationManager=new m.models.NotificationManager,m.models.date&&(m.models.date.setDateUpdateTimer(),m.models.date.setSecondsUpdateTimer()),this.trackPageVisibility(),this.newDayIntervalId=setInterval(function(){var e;window.Cypress&&document.body.setAttribute("data-test-new-day-interval-check-has-run",""),localStorage.activeDate?localStorage.activeDate!=m.utils.getDateString()&&(e=9e3*Math.random()+1e3,setTimeout(function(){localStorage.activeDate=m.utils.getDateString(),m.trigger("newDay")},e)):localStorage.activeDate=m.utils.getDateString()},1e4);var e=this.getOneTimeLoginParams(),e=(e.otpUuid&&e.otp?(m.widgetManager.loadWidget("modal"),m.widgetManager.showDashboard(),m.cmd("modal.open","ONE_TIME_LOGIN",{otlParams:e})):m.utils.shouldShowIntroduction()?(m.widgetManager.loadWidget("modal"),m.widgetManager.showDashboard(),m.cmd("modal.open","LOGIN")):m.utils.userIsLegacyUnregistered()||localStorage.getItem(m.constants.LEGACY_USER_MIGRATION_KEYS.TIME)?m.legacyUserMigration.migrateIfEligible().then(this.loadWidgets.bind(this)):this.loadWidgets(),m.versionDeprecationWarningCheck(),$("body")),t=m.utils.getBrowserName();m.utils.isTouchDevice()&&e.addClass("touch"),e.addClass(t),this.initializeCompleted=!0},loadWidgets:function(){m.readyForWidgets=!0,m.trigger("readyForWidgets"),this.render()},trackPageVisibility:function(){var e,t;void 0!==document.hidden?(e="hidden",t="visibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),void 0!==e&&this.addEventHandler(document,t,function(){m.trigger(document[e]?"globalEvent:pageHidden":"globalEvent:pageShown")})},addEventHandler:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},processAddIns:function(){var e=this;e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending())},50)},render:function(){this.renderedOnce||(this.renderedOnce=!0,m.views.backgroundInfo&&m.widgets.push(m.views.backgroundInfo),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.trigger("main-render-complete"))},getViewById:function(t){var i=null;return _.each(m.widgets,function(e){e.el.id===t&&(i=e)}),i},removeView:function(t){_.each(m.widgets,function(e){e.el.id===t&&e.$el.mFadeOut(500,!1,function(){e.remove(),m.widgets.splice(m.widgets.indexOf(e),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.mFadeOut(500,!1,function(){e.remove()})}),m.widgets=[],_.delay(e,475)},getOneTimeLoginParams:function(){return m.utils.getAndRemoveParamsFromUrl("otp","otpUuid","email","legacy")}});var bootstrap=function(){var e;setTimeout(function(){try{var e="";for(o=0;o<100;o++)e+="aaaaaaaaaa";localStorage.setItem("capacityTest",e),localStorage.removeItem("capacityTest")}catch(e){try{localStorage.removeItem("capacityTest");for(var t=m.now()-1728e5,i=[],n=!1,a=null,o=0;o<localStorage.length;o++)n=!1,"no-mantra"==(a=localStorage.key(o)).substring(0,9)&&(n=!0),"no-quote"==a.substring(0,8)&&(n=!0),"no-background"==a.substring(0,13)&&(n=!0),"last_cleanup"==a.substring(0,12)&&(n=!0),"archived-"==a.substring(0,9)&&(n=!0),"fallback-"==a.substring(0,9)&&(n=!0),"listCache-"==a.substring(0,10)&&(n=!0),"font-"==a.substring(0,5)&&(n=!0),"image_displayed-"==a.substring(0,16)&&(n=!0),"weather"==a.substring(0,7)&&(n=!0),"bookmarks"==a.substring(0,9)?n=!0:"ddl-bg-"==a.substring(0,7)?localStorage.getItem(a)<t&&(n=!0):"ddl-qt-"==a.substring(0,7)&&localStorage.getItem(a)<t&&(n=!0),n&&i.push(a);for(o=0;o<i.length;o++)localStorage.removeItem(i[o])}catch(e){}}},3e3),m.isLoggedIn()&&(localStorage.getItem("user_uuid")||(e=localStorage.getItem("token"),(e=m.utils.parseJwt(e))&&(e=e.user_uuid||e.user_guid)&&localStorage.setItem("user_uuid",e.toLowerCase())),localStorage.removeItem("pendingLoginState")),m.models.date=new m.models.Date,m.models.customization=new m.models.ComputedSettings({id:1}),m.listenToOnce(m.models.customization,"initialized",m.onSettingsInitialized),m.console.log(m.elapsed()+": Settings requested"),m.models.teamInfo=new m.models.TeamInfo,m.models.customization.initializeSettings()};try{window.chrome&&window.chrome.extension&&window.chrome.extension.inIncognitoContext&&!m.utils.isSafari()?$("body").html(""):m.utils.domReady(bootstrap)}catch(e){m.utils.domReady(bootstrap)}function sendAndCaptureAnalyticsBatchEvent(){null===localStorage.getItem("analytics:batchEventNames")&&m.Analytics.capture("tab load",{count:0}),m.Analytics.sendBatchEventsIfNeeded(),m.Analytics.batchCapture("tab load")}function loadModals(){m.cmd("notification.safariUpdate.shouldShow")&&m.cmd("notification.safariUpdate.show"),m.widgetManager.loadWidget("modal")}function removeHideOverlay(){document.getElementById("introduction")||document.body.classList.remove("hide-overlay")}function registerDeferredListeners(){m.listenersRegistered||(m.$e.addCrossTabMessageListener("reload",function(){location.reload()}),window.addEventListener("storage",function(e){"activeDate"==e.key&&e.oldValue!=e.newValue&&(e=9e3*Math.random()+1e3,setTimeout(function(){m.trigger("newDay")},e))}),$(window).on("resize",function(){m.trigger("globalEvent:window:resize")}),window.onblur=function(){m.trigger("globalEvent:windowBlur")},$(document).on("click",function(e){m.trigger("globalEvent:click",e)}),$(document).on("keyup",function(e){if(!m.tourActive&&!m.reactive.dashboardOverlayActive){if(27==e.keyCode&&m.trigger("globalEvent:esc",e),32==e.keyCode){var t=m.widgetManager.getWidget("todo");if(t&&t.isHovered)return;if(m.utils.isInputOrTextAreaActive())return;m.trigger("pomodoro:togglePlay",e),m.trigger("soundscapes:togglePlay",e),e.stopPropagation(),e.preventDefault()}"Alt"==e.key&&m.trigger("globalEvent:altUp",e)}}),$(document).on("keydown",function(e){var t;if(!m.tourActive&&!m.reactive.dashboardOverlayActive&&(9===e.keyCode&&(m.trigger("globalEvent:key:tab"),"BODY"===document.activeElement.tagName)&&(e.preventDefault(),((i=$("#search-input")).length?i:(i=$("#focuses").find("input")).length?i:$("a").filter(":visible").first()).trigger("focus")),8==e.keyCode&&e.shiftKey&&e.metaKey&&m.trigger("globalEvent:metaBackspace",e),13==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaEnter",e),78==e.keyCode&&e.ctrlKey&&m.trigger("globalEvent:ctrlN",e),70==e.keyCode&&e.altKey&&m.trigger("globalEvent:altF",e),76==e.keyCode&&e.altKey&&m.trigger("globalEvent:altL",e),e.altKey&&38==e.keyCode&&m.trigger("globalEvent:altArrowUp",e),e.altKey&&40==e.keyCode&&m.trigger("globalEvent:altArrowDown",e),!e.metaKey||e.shiftKey||e.ctrlKey||e.altKey||("["===e.key&&m.trigger("globalEvent:metaBracketLeft",e),"]"===e.key&&m.trigger("globalEvent:metaBracketRight",e),"/"===e.key&&m.trigger("globalEvent:metaForwardSlash",e),"\\"===e.key&&m.trigger("globalEvent:metaBackSlash",e),"k"===e.key&&m.trigger("globalEvent:metaK",e)),"n"===e.key&&e.metaKey&&e.ctrlKey&&m.trigger("globalEvent:metaCtrlN",e),"`"===e.key&&e.ctrlKey&&e.shiftKey&&m.trigger("globalEvent:ctrlShiftBacktick",e),!e.ctrlKey&&!e.metaKey&&!(e.altKey&&78!=e.keyCode||m.utils.isInputOrTextAreaActive()))){if(76==e.keyCode)m.trigger("globalEvent:key:L",e);else if(70==e.keyCode)t="Focus";else if(84==e.keyCode)m.trigger("globalEvent:key:T",e);else if(83==e.keyCode)t="Search";else if(188==e.keyCode){if(e.metaKey)return;t="Settings"}else{if(67==e.keyCode&&m.utils.isChromium())return void m.utils.getBrowser().tabs.update({url:m.utils.getChromeNewTabPageUrl()});if(8==e.keyCode)m.trigger("globalEvent:key:backspace",e);else if(13==e.keyCode)m.trigger("globalEvent:key:enter",e);else if(32==e.keyCode)m.trigger("globalEvent:spacebar",e);else if(38==e.keyCode)m.trigger("globalEvent:arrowUp",e);else if(40==e.keyCode)m.trigger("globalEvent:arrowDown",e);else if(37==e.keyCode)m.trigger("globalEvent:arrowLeft",e);else if(39==e.keyCode)m.trigger("globalEvent:arrowRight",e);else if(65==e.keyCode)m.trigger("globalEvent:key:A",e);else if(73==e.keyCode)m.trigger("globalEvent:key:I",e);else if(78==e.keyCode&&e.shiftKey)m.trigger("globalEvent:key:shiftN",e);else if(78!=e.keyCode||e.shiftKey)if(80==e.keyCode)m.trigger("globalEvent:key:P",e);else if(86==e.keyCode)m.trigger("globalEvent:key:V",e);else if(87==e.keyCode)m.trigger("globalEvent:key:W",e);else if(66==e.keyCode){if(m.utils.bookmarksNotSupported())return;if(void 0===m.utils.getBrowser().bookmarks||void 0===m.utils.getBrowser().topSites)return;m.widgetManager.loadWidget("bookmarks");var i=!m.models.customization.get("bookmarksVisible");m.models.customization.save("bookmarksVisible",i),m.Analytics.capture("feature "+(i?"enable":"disable"),{feature:"bookmarks",location:"hotkey"})}else e.shiftKey&&191==e.keyCode&&m.commandManager.execute("settings.toggle",null,{section:"help"});else m.trigger("globalEvent:key:N",e)}t&&(m.trigger("globalEvent:toggle"+t.replace(/\s+/g,"")),e.preventDefault())}}),m.utils.isSafari()&&$("a").on("click",function(){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})}),m.listenersRegistered=!0)}function registerCustomBackgroundListeners(){var i;m.customBackgroundListenersRegistered||(i=$("body"),!m.utils.isTouchDevice()&&m.conditionalFeatures.featureEnabled("custom-bg")&&(m.appView.addEventHandler(document.body,"dragover",function(e){e.stopPropagation(),e.preventDefault(),_.contains(e.dataTransfer.types,"Files")?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none"}),window.addEventListener("dragenter",function(e){_.contains(e.dataTransfer.types,"Files")&&(m.appView.lastTarget=e.target,i.addClass("blur show-drop"))}),window.addEventListener("dragleave",function(e){e.preventDefault(),e.target!==document&&e.target!==m.appView.lastTarget||i.removeClass("blur show-drop")},!1),window.addEventListener("dragover",function(e){e.preventDefault()}),m.appView.addEventHandler(document.body,"drop",function(e){var t;e&&e.dataTransfer.files.length&&Array.prototype.some.call(e.dataTransfer.files,function(e){return e&&e.name.match(/\.(gif|jpg|jpeg|tiff|png)$/i)})?(e.stopPropagation(),e.preventDefault(),i.removeClass("blur show-drop"),_.contains(e.dataTransfer.types,"Files")&&(m.conditionalFeatures.featureEnabled("custom-bg")?(t=e.dataTransfer.files)&&0<t.length&&m.commandManager.ensureCommandLoaded("background.custom.uploadfiles",function(){m.commandManager.execute("background.custom.uploadfiles",t)},null,function(){}):m.cmd("modal.open","UPSELL_PHOTOS",{eventSource:"dash"}))):i.removeClass("blur show-drop")}),m.customBackgroundListenersRegistered=!0))}m.onSettingsInitialized=function(){m.console.log(m.elapsed()+": Settings initialized");var e="installed-"+m.globals.version;localStorage.getItem(e)||localStorage.setItem(e,Date.now()),m.models.cleanupManager=new m.models.CleanupManager,m.addinManager=new m.models.AddinManager,m.commandManager=new m.CommandManager,m.cmd=m.commandManager.execute.bind(m.commandManager),(m.models.customization.get("displayname")||m.isLoggedIn())&&!localStorage.doLoginOnNextLoad||(m.prelogin=!0),m.models.mantraManager=new m.models.MantraManager,m.widgetManager=new m.models.WidgetManager,m.widgetManager.setupWhenReady(),m.appView=new m.views.Dashboard,!localStorage.getItem("offered-plan")&&m.conditionalFeatures.featureEnabled("notes-degraded")&&$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootLogin+"account/history"}).done(function(e){e.offeredPlan&&localStorage.setItem("offered-plan",e.offeredPlan)}),localStorage.client_uuid?window.Cypress&&$("body").attr("data-test-ready-for-tests",""):$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!==e.client_uuid&&(localStorage.getItem("token")||localStorage.setItem("registrationStatePending",!0),localStorage.client_uuid=e.client_uuid,window.Cypress)&&$("body").attr("data-test-ready-for-tests","")}).fail(console.error),m.syncCoordinator=new m.models.SyncCoordinator,localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),m.syncCoordinator.syncSettings(),m.appView.listenToOnce(m,"appsReady",registerDeferredListeners),m.appView.listenTo(m,"appsReady",registerCustomBackgroundListeners),m.appView.listenTo(m,"appsReady",removeHideOverlay),m.appView.listenTo(m,"appsReady",loadModals),m.appView.listenToOnce(m,"appsReady",sendAndCaptureAnalyticsBatchEvent)};